# Bugs Log & Solutions

## 20.01.2026 - Ошибки валидации и отображения (Закупщик/Оператор)
**Версия:** 1.18.131
**Проблемы:** 
1. Не отображались звездочки (*) и красная обводка для обязательных полей "Комментарий" и "WeChat ID" у Закупщика.
2. При редактировании оффера позиции со статусом "Отказ" (кол-во 0) сбрасывались на дефолтное количество.
3. Оператор не видел комментарий поставщика под вариантом в списке.
4. Поле WeChat ID у Менеджера отображалось со смещением (как степень).
**Причины:** 
1. В компонент карточки передавался булевый флаг `isRequired` вместо объекта настроек `requiredFields`. Логика `cfgComment` не могла прочитать ключи.
2. Инициализация использовала оператор `||` (`offeredQuantity || quantity`), который считает `0` (отказ) ложным значением и подставляет дефолт.
3. Поле `comment` было добавлено в SQL-запрос `fetch.ts`, но пропущено в map-функции, формирующей объект для фронтенда.
4. CSS-свойство `items-start` в flex-контейнере и `font-mono` создавали визуальный дефект.
**Решения:** 
1. Исправлена передача пропсов в `BuyerOrderDetails` и переписана функция `getInputClass`.
2. Заменено на Nullish Coalescing (`??`), что сохраняет `0`.
3. Добавлен маппинг `comment: oi.comment` в `fetch.ts`.
4. Стили упрощены, выравнивание изменено на `items-center`.
**Статус:** Исправлено

## 20.01.2026 - Critical Syntax Error (500) в BuyerOrdersList
**Версия:** 1.18.129
**Проблема:** При загрузке страницы закупщика возникала ошибка 500 (Unexpected token).
**Причина:** При автоматическом редактировании файла была удалена закрывающая скобка компонента и блока `return`.
**Решение:** Полностью перезаписан файл с корректным синтаксисом.
**Статус:** Исправлено

## 19.01.2026 - Исчезновение комментария закупщика при сохранении/чтении
**Версия:** 1.18.133
**Проблема:** Закупщик вводит комментарий в режиме "Изменить", сохраняет, видит его в UI, но после перезагрузки поле пустое. В БД при этом данные есть.
**Причина:** 
1. `BuyerOrderRow` передавал в детали неполный объект `myOffer` из списка (без поля `comment`). 
2. `useEffect` в деталях срабатывал при переключении `isEditing` и затирал стейт старыми данными из пропсов до завершения рефетча.
**Решение:** 
1. В `BuyerOrderRow` реализован поиск `detailedMyOffer` внутри уже загруженных полных деталей заказа.
2. В `BuyerOrderDetails` `useEffect` теперь реагирует только на реальное изменение объекта `myOffer` (после успешного рефетча), исключая гонку состояний при переключении режимов.
**Статус:** Исправлено

## 19.01.2026 - Ошибка "Вы уже отправили предложение" при отказе
**Версия:** 1.18.135
**Проблема:** При попытке нажать "Отказаться" (если оффер уже был, например, черновик), вылетал alert с ошибкой дубликата.
**Причина:** Функция `handleSubmitOffer` всегда вызывала `createOffer` (INSERT), не проверяя наличие существующей записи в таблице `offers`.
**Решение:** В `handleSubmitOffer` добавлена проверка через `getMyOffer`. Если оффер существует — вызывается `editOffer` (UPDATE) с новым статусом, иначе — `createOffer`.
**Статус:** Исправлено

## 19.01.2026 - Рассинхрон счетчиков "Архив" и "КП у клиента" у Менеджера
**Версия:** 1.18.132
**Проблема:** Счетчик архива показывал `+2`, хотя в списке было 10+ заказов. Заказы "КП отправлено" отображались не в тех табах.
**Причина:** Разная логика фильтрации в компоненте `AdminInterface` (UI) и SQL-функции `getStatusCounts` (подсчет). Статус "Выполнен" не считался архивом, а "КП отправлено" считался активным.
**Решение:** Синхронизированы маппинги статусов. "КП отправлено" возвращен в "КП у клиента" (как активная сделка), "Выполнен" перенесен в "Архив" (финальный статус). Обновлена функция `getStatusCounts`.
**Статус:** Исправлено

## 18.01.2026 - Ошибка доступа RLS (401) к Чек-листу
**Версия:** 1.18.128
**Проблема:** При попытке загрузить или сохранить чек-лист возникала ошибка `401 Unauthorized`.
**Причина:** Для новой таблицы `admin_checklist` не были настроены политики RLS, а так как авторизация в проекте кастомная (не через Supabase Auth), стандартный доступ был закрыт.
**Решение:** Отключен RLS (`ALTER TABLE ... DISABLE ROW LEVEL SECURITY`) и выданы права `GRANT ALL` для ролей `anon` и `authenticated`.
**Статус:** Исправлено

## 18.01.2026 - Ошибка PGRST204 (subItems column not found)
**Версия:** 1.18.128
**Проблема:** При сохранении чек-листа Supabase возвращал ошибку `Could not find the 'subItems' column`.
**Причина:** В коде React использовался camelCase (`subItems`), а в базе данных — snake_case (`sub_items`). При отправке объекта целиком Supabase пытался записать несуществующее поле.
**Решение:** В методах API (`resetChecklist`, `upsertChecklistItem`) добавлена явная фильтрация и маппинг полей перед отправкой.
**Статус:** Исправлено

## 18.01.2026 - Критическая ошибка верстки (500) в BuyerOrderRow
**Версия:** 1.18.125
**Проблема:** Белый экран (Internal Server Error) при открытии списка заказов закупщика.
**Причина:** При рефакторинге компонента случайно был продублирован блок `return (` и открывающий `div`, что сломало синтаксис JSX.
**Решение:** Удален дублирующийся код.
**Статус:** Исправлено

## 18.01.2026 - Нечитабельный UI на мобильных устройствах
**Версия:** 1.18.123-125
**Проблема:** 
1. Таблицы (`OperatorOrderItems`, `BuyerItemCard`) сжимались до нечитаемого состояния (по одной букве в строке).
2. Кнопки действий вылезали за пределы экрана.
3. Табы навигации обрезались без возможности прокрутки.
**Причина:** Использование жестких сеток (`grid-cols-[...]`) и фиксированных отступов, не рассчитанных на ширину 375px.
**Решение:** 
1. Реализован адаптивный дизайн: Таблицы превращаются в Карточки (Card View) на мобильных.
2. Второстепенные действия (Копировать, Отказаться, Чат) спрятаны в выпадающее меню ("Три точки" или "Menu").
3. Добавлен `overflow-x-auto` для табов и `break-words` для длинных названий.
**Статус:** Исправлено

## 18.01.2026 - Сброс цены оффера при редактировании
**Версия:** 1.18.122
**Проблема:** При нажатии "Изменить" цена оффера сбрасывалась на 0 или не сохранялась после ввода.
**Причина:** Конфликт приоритетов полей в функции маппинга (`item.sellerPrice` vs `item.BuyerPrice`). Значение undefined перезаписывало существующую цену.
**Решение:** В `edit.ts` установлен строгий приоритет: `BuyerPrice` (ввод) -> `sellerPrice` (БД) -> 0. Добавлены проверки на undefined.
**Статус:** Исправлено

## 17.01.2026 - Ошибка TypeError (kp_count) на Дашборде Закупщика
**Версия:** 1.18.118
**Проблема:** При открытии дашборда закупщика возникала ошибка `TypeError: Cannot read properties of undefined (reading 'kp_count')`.
**Причина:** SQL-функция `get_buyer_dashboard_stats` возвращала плоский объект с данными, в то время как фронтенд ожидал вложенную структуру `{ personal: {...}, department: {...}, leaders: {...} }`.
**Решение:** Обновлена SQL-функция в базе данных (и файл миграции), чтобы возвращаемый JSON соответствовал интерфейсу `BuyerDashboard`.
**Статус:** Исправлено

## 17.01.2026 - Двойная загрузка файлов и Race Condition в Dropzone
**Версия:** 1.18.116
**Проблема:** 
1. При сбросе файла на позицию он добавлялся и в позицию, и в общие файлы.
2. При сбросе пачки файлов загружался только один.
**Причина:** 
1. Событие `drop` всплывало от дочернего элемента к глобальному контейнеру.
2. Асинхронные обновления стейта в цикле `forEach` перезаписывали друг друга из-за замыкания.
**Решение:** 
1. Добавлен `event.stopPropagation()` в локальные обработчики `onDrop`.
2. Логика загрузки переписана на `await Promise.all()` с единичным обновлением стейта.
**Статус:** Исправлено

## 17.01.2026 - Ошибка 404/400 при утверждении заказа Менеджером
... (остальное без изменений)
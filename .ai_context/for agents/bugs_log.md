# Bugs Log & Solutions

## 17.01.2026 - Некорректная работа Real-time оверлеев у Менеджера
**Версия:** 1.18.120
**Проблема:** Менеджер не видел оверлей "Закупщик вносит изменения...", хотя сигнал в консоль приходил.
**Причина:** 
1. Функция `getOrderDetails` не запрашивала поле `locked_at` из БД, поэтому после получения Real-time уведомления данные обновлялись, но блокировка оставалась невидимой.
2. В self-hosted Supabase для таблицы `offers` не была включена опция `REPLICA IDENTITY FULL`, что мешало передаче полных данных об изменении строк.
**Решение:** 
1. Поле `locked_at` добавлено в `select` и маппинг в `details.ts`.
2. В БД выполнена команда `ALTER TABLE offers REPLICA IDENTITY FULL;`.
**Статус:** Исправлено

## 17.01.2026 - Ошибка Conflict (409) при обновлении оффера
**Версия:** 1.18.120
**Проблема:** При попытке сохранить измененный оффер возникала ошибка `duplicate key value violates unique constraint "offer_items_unique_idx"`.
**Причина:** Мы добавили уникальный индекс на `(offer_id, order_item_id)`, но метод `upsert` в Supabase JS по умолчанию пытается сопоставить строки только по Primary Key (`id`). Если ID не передан (или не совпал), он делает `INSERT`, что вызывает конфликт.
**Решение:** В вызов `upsert` добавлен параметр `{ onConflict: 'offer_id, order_item_id' }`, что принудительно переводит операцию в режим `UPDATE` при совпадении пары ключей.
**Статус:** Исправлено

## 17.01.2026 - Ошибка TypeError (kp_count) на Дашборде Закупщика
**Версия:** 1.18.118
**Проблема:** При открытии дашборда закупщика возникала ошибка `TypeError: Cannot read properties of undefined (reading 'kp_count')`.
**Причина:** SQL-функция `get_buyer_dashboard_stats` возвращала плоский объект с данными, в то время как фронтенд ожидал вложенную структуру `{ personal: {...}, department: {...}, leaders: {...} }`.
**Решение:** Обновлена SQL-функция в базе данных, чтобы возвращаемый JSON соответствовал интерфейсу `BuyerDashboard`.
**Статус:** Исправлено

## 17.01.2026 - Двойная загрузка файлов и Race Condition в Dropzone
**Версия:** 1.18.116
**Проблема:** 
1. При сбросе файла на позицию он добавлялся и в позицию, и в общие файлы.
2. При сбросе пачки файлов загружался только один.
**Причина:** 
1. Событие `drop` всплывало от дочернего элемента к глобальному контейнеру.
2. Асинхронные обновления стейта в цикле `forEach` перезаписывали друг друга из-за замыкания.
**Решение:** 
1. Добавлен `event.stopPropagation()` в локальные обработчики `onDrop`.
2. Логика загрузки переписана на `await Promise.all()` с единоразовым обновлением стейта.
**Статус:** Исправлено

## 17.01.2026 - Ошибка 404/400 при утверждении заказа Менеджером
**Версия:** 1.18.115
**Проблема:** При нажатии кнопки "Утвердить КП" в консоли возникали ошибки `404 Not Found` (функция `approve_order_winners` не найдена) и затем `400 Bad Request` (колонки `delivery_weeks` не существует).
**Причина:** 
1. Функция финализации заказа `approve_order_winners` не была перенесена в новую базу Supabase.
2. В структуре `order_items` отсутствовало поле для хранения итогового срока.
**Решение:** 
1. Написана и применена SQL-функция `approve_order_winners`.
2. В таблицу `order_items` добавлена колонка `delivery_weeks` (numeric).
**Статус:** Исправлено

## 17.01.2026 - Утечка доступа к Supabase Studio
**Версия:** 1.18.112
**Проблема:** При открытии порта 8001 для Studio она становилась доступна всему интернету без пароля.
**Причина:** Docker пробрасывает порты напрямую в `iptables`, игнорируя правила UFW (Firewall).
**Решение:** 
1. В `docker-compose` порт привязан строго к `127.0.0.1:8001:3000`.
2. Доступ организован через Nginx на внешнем порту 8001 с использованием `auth_basic`.
**Статус:** Исправлено
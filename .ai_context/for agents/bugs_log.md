# Лог Багов и Решений

Этот файл служит базой знаний о проблемах, с которыми мы столкнулись, и о том, как они были решены.

---

## 10.01.2026 - Комплексная проблема потери и отображения файлов (Оператор -> Закупщик -> Менеджер)
**Версия:** 1.18.42 - 1.18.51

**Проблема:** 
Пользователь сообщил о массовой потере данных при работе с файлами на всех этапах воронки:
1. **Слова пользователя:** "Я за оператора создаю заявку, даю 2 файла в позицию №1, 2 файла в позицию №2, и 2 файла в общий дроп (по заказу) итого 6 файлов. Захожу за менеджера в заказ, в позициях вижу по 1 файлу, и 2 общих файла в Вложения, итого я вижу 4 файла, вместо 6."
2. **Ошибка в консоли (Оператор):** `{code: 'PGRST204', message: "Could not find the 'item_files' column of 'order_items' in the schema cache"}`. Из-за этого товары вообще не записывались в базу в некоторых случаях.
3. **Слова пользователя (Закупщик):** "Почти! Я вижу теперь файлы от оператора, но за закупщика они почему-то от моего лица проставились. Т.е я хочу сказать, что открыв ордер, у меня были будто предзаданы уже файлы, хотя я еще ничего не загрузил."
4. **Слова пользователя (Менеджер):** "У менеджера показывается лишь файлы от поставщика по позициям, но не показывает общие в блоке Файлы от поставщиков."

**Причина:** 
1. **База данных (Критично):** В таблице `order_items` физически отсутствовала колонка `item_files` для хранения массива метаданных файлов. Код пытался писать в неё, получал ошибку 400 и прерывал вставку позиций.
2. **Маппинг данных (Оператор):** В `OperatorInterface.tsx` внутри функции `handleCreateOrder` при формировании массива `itemsForDb` поле `itemFiles` было пропущено. Сохранялось только `photoUrl` (строка, первый файл).
3. **Логика инициализации (Закупщик):** В `BuyerOrdersList.tsx` при создании черновика предложения (`editingItems`) объект наследовал все поля из `order.items`, включая файлы оператора. Из-за отсутствия явной очистки `itemFiles: []`, закупщик видел чужие файлы как свои.
4. **Отображение (Закупщик):** Карточка товара `BuyerItemCard` использовала один и тот же объект данных для отображения инфо оператора и для ввода данных закупщика.
5. **Обработка события (Закупщик):** В `BuyerInterface.tsx` функция `handleSubmitOffer` принимала только два аргумента, игнорируя третий — `supplierFiles` (общие файлы оффера).

**Решение:** 
1. **DB Fix:** Создана и применена миграция `sql/76_add_item_files.sql`, добавляющая `jsonb` колонку `item_files` в `order_items` и `offer_items`.
2. **Service Layer Fix:** 
   - В `src/services/api/orders/fetch.ts` и `details.ts` добавлен запрос колонки `item_files` и её маппинг в поле `itemFiles`.
   - В `src/services/api/offers/create.ts` подтверждена поддержка сохранения `supplier_files`.
3. **Operator Fix:** В `OperatorInterface.tsx` изменен цикл сборки позиций — добавлена явная передача `itemFiles: p.itemFiles`.
4. **Buyer Interface Fix:** 
   - В `BuyerOrdersList.tsx` при инициализации `getInitialItems` добавлена строка `itemFiles: []`.
   - В `BuyerInterface.tsx` обновлена сигнатура `handleSubmitOffer(orderId, items, supplierFiles)`, теперь файлы пробрасываются в API.
5. **Buyer UI Refactor:** 
   - В `BuyerItemCard.tsx` добавлен проп `sourceItem` для передачи "чистых" данных из БД. Теперь верхняя часть карточки (Оператор) и нижняя (Закупщик) берут файлы из разных источников.
   - Блок "Вложения" в `BuyerOrderDetails.tsx` переписан 1-в-1 по логике Менеджера (вертикальный список с группировкой по типу).
6. **UI Rename:** В `AdminOrdersList.tsx` заголовок блока "Файлы от поставщиков" изменен на "Файлы от закупщиков" по просьбе пользователя.

**Статус:** Исправлено (подтверждено пользователем)

---

## 11.01.2026 - Глобальный рефакторинг статусов и внедрение Ручной Обработки
**Версия:** 1.18.57 - 1.18.59

**Проблема:** 
1. **API Error 400:** После переименования колонки `status_admin` -> `status_manager` в БД, клиентское приложение начало получать ошибки `record "new" has no field "status_admin"`.
2. **Propagated Errors:** Старое имя колонки использовалось в триггерах БД, RPC-функциях, API-запросах (fetch.ts, dashboard.ts) и типах.
3. **Data Loss (Dev):** В процессе миграции на локальной/тестовой среде были удалены все заказы (count: 0), что вызвало пустые листинги.
4. **Render Error:** `ReferenceError: itemOffers is not defined` в `AdminItemsTable` из-за ошибки области видимости при рефакторинге.
5. **Logic Error:** При переводе в ручной режим офферы не становились победителями, из-за чего оператор не видел кнопок копирования.

**Причина:** 
1. Неполное обновление зависимостей после `RENAME COLUMN`. Postgres не обновляет код внутри функций PL/pgSQL.
2. Хардкод имен колонок в клиентском коде и хуках.
3. Отсутствие вызова `set_manual_mode` (RPC) в первой версии реализации.

**Решение:** 
1. **DB Migration:** Создана миграция `80_fix_all_status_admin.sql`, пересоздающая все зависимые функции (`get_seller_feed`, `trigger_on_kp_sent`, `auto_archive_chats`) с новым именем колонки.
2. **Codebase Refactor:** Массовая замена `status_admin` -> `status_manager` во всем проекте (`src/`).
3. **RPC Implementation:** Создана и внедрена SQL-функция `set_manual_mode`, которая атомарно меняет статус заказа и проставляет `is_winner=true` всем офферам.
4. **UI Fixes:** 
   - Восстановлен `AdminItemsTable` с корректной логикой `itemOffers`.
   - Обновлен `BuyerInterface` для поддержки статуса "Отказ".
   - Реализована "заморозка" (фиксация) срока доставки в `client_delivery_weeks`.

**Статус:** Исправлено

**Версия:** 1.18.49

**Проблема:** 

При наведении на иконку "+2" (список файлов) в карточке закупщика, выпадающее меню обрезается границами карточки или перекрывается заголовком таблицы, делая невозможным просмотр и клик по ссылкам.



**Причина:** 

У контейнеров `BuyerItemCard` и `BuyerOrderDetails` (блок таблицы) было установлено CSS-свойство `overflow-hidden`. Плюс `z-index` выпадающего списка был недостаточно высоким для перекрытия "липкого" хедера таблицы.



**Решение:** 

1. Убран класс `overflow-hidden` из контейнеров `BuyerItemCard` и обертки таблицы.

2. Для сохранения скругленных углов таблицы добавлен `rounded-t-xl` к заголовку.

3. Увеличен `z-index` выпадающего списка до `z-[999]`.



## 11.01.2026 - Проблемы уведомлений и сброса прочитанных в чате



**Версия:** 1.18.60 - 1.18.61







**Проблема:** 



1. **Слепые уведомления:** Оператор не видел бейдж "+1" на иконке чата при получении системного сообщения о переводе заказа в ручной режим.



2. **Счетчик не сбрасывался:** При открытии чата Оператором сообщение оставалось "непрочитанным" в базе и на иконке.



3. **Отсутствие индикации в архиве:** В окне `GlobalChatWindow` было непонятно, есть ли новые сообщения в табе "Архив", пока в него не зайдешь.







**Причина:** 



1. Функция `getUnreadChatCount` считала только сообщения с `sender_role = 'SUPPLIER'`. Системные сообщения от Менеджера (`ADMIN`) игнорировались.



2. В `ChatWindow` логика `shouldMark` не учитывала, что Оператор может читать сообщения от Админа.



3. Фронтенд запрашивал список тредов только для активного таба, игнорируя состояние архива.







**Решение:** 



1. **API Fix:** Создана функция `getOperatorUnreadCount` (вынесена в `stats.ts`), учитывающая системные уведомления `ADMIN` -> `OPERATOR`.



2. **Logic Fix:** Обновлены `markChatAsRead` и `ChatWindow.tsx` для корректной обработки прочтения системных сообщений Оператором.



3. **UI Fix:** В `GlobalChatWindow` и `BuyerGlobalChat` внедрена параллельная загрузка обоих типов тредов. На кнопки табов добавлены анимированные (pulse) бейджи с общим количеством непрочитанных в каждой категории.







**Статус:** Исправлено







---







## 10.01.2026 - Окно файлов скрывается за хедером таблицы

**Версия:** 1.18.53

**Проблема:** 

По умолчанию список заказов сортировался по дедлайну (deadline asc). Пользователю приходилось каждый раз прокручивать список или искать новые заказы, так как свежие поступления могли быть разбросаны в зависимости от срока.



**Причина:** 

Изначальная конфигурация `sortConfig` в `BuyerInterface.tsx` была `{ key: 'deadline', direction: 'asc' }`.



**Решение:** 

Изменена дефолтная сортировка на `{ key: 'id', direction: 'desc' }`. Теперь новые заказы (с большим ID) всегда находятся вверху списка.



**Статус:** Исправлено (подтверждено пользователем)

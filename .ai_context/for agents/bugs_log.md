# Bugs Log & Solutions

## 25.01.2026 - Crash: ReferenceError (offerEditTimeout) в Админке
**Версия:** 1.18.136 -> 1.18.137
**Проблема:** Белый экран при загрузке админ-панели (список заказов). Ошибка: `offerEditTimeout is not defined`.
**Причина:** Переменная использовалась внутри `AdminOrdersList.tsx`, но не была добавлена в деструктуризацию пропсов компонента.
**Решение:** Добавлено поле `offerEditTimeout` в аргументы функции компонента.
**Статус:** Исправлено

## 25.01.2026 - Logic: Не работало выделение "своих" заказов у Закупщика
**Версия:** 1.18.136
**Проблема:** Карточки заказов, назначенных лично закупщику, не подсвечивались анимацией, хотя должны были.
**Причина:** Параметр `buyerId` не передавался через цепочку компонентов `BuyerInterface` -> `BuyerOrdersList` -> `MemoizedBuyerOrderRow`. Из-за этого сравнение ID возвращало `false`.
**Решение:** Проброшен проп `buyerId` во все вложенные компоненты списка заказов.
**Статус:** Исправлено

## 23.01.2026 - Ошибки навигации "Перейти к заказу" (Оператор/Закупщик)
**Версия:** 1.18.134 -> 1.18.136
**Проблема:** 
1. Оператор: при переходе из чата заказ не раскрывался, не было скролла. Повторный клик не работал.
2. Закупщик: таб не менялся (заказ уходил в архив), поле поиска не заполнялось визуально.
**Причина:** 
1. В `OperatorInterface` стейт `navigateToOrderId` не сбрасывался после перехода (блокировка повторного срабатывания `useEffect`).
2. В `fetch.ts` жесткий фильтр по статусу таба мешал найти заказ по ID, если тот находился в другой вкладке.
3. В `BuyerInterface` использовалось неверное имя поля `status_manager` (вместо `status_admin`) при деструктуризации ответа API.
4. В `BuyerToolbar` локальный стейт поиска не синхронизировался с внешним пропом.
**Решение:** 
1. Внедрен колбэк `onNavigateComplete` для сброса стейта навигации.
2. В API `getOrders` добавлен приоритет поиска по ID (игнорирование табов).
3. `OperatorOrderRow` переведен на автономную подгрузку данных (`useQuery`).
4. Исправлен маппинг полей в `BuyerInterface` и добавлен `useEffect` в `BuyerToolbar`.
**Статус:** Исправлено

## 23.01.2026 - P2P Chat Initialization & Privacy Logic
**Версия:** 1.18.133 -> 1.18.134
**Проблема:** 
1. При переходе на P2P архитектуру чата, новые диалоги не открывались (пустое окно, нет поля ввода) у Менеджера и Закупщика.
2. Сообщения смешивались в "общие котлы" по ролям, нарушая приватность между операторами.
3. Закупщик получал ошибку "Пользователь не определен" при отправке.
**Причина:** 
1. В `GlobalChatWindow` использовался несуществующий импорт `SupabaseService.supabase`, что вызывало краш при создании виртуального треда.
2. В `AdminOrdersList` и `BuyerGlobalChat` не передавались корректные UUID собеседников (`ownerId` / `created_by`) или самого пользователя (`currentUserId`).
3. API методы `getGlobalChatThreads` имели устаревшую сигнатуру с фильтрацией по имени/роли.
**Решение:** 
1. Полный рефакторинг API чата на строгую фильтрацию по UUID (`sender_id`, `recipient_id`).
2. Внедрение механизма "Виртуальных тредов" в `GlobalChatWindow` для инициализации новых диалогов.
3. Исправление всех вызовов компонентов чата для передачи явных UUID.
4. Добавление `ownerId` в ответ `getOrderDetails` для корректного маппинга.
**Статус:** Исправлено

## 20.01.2026 - Toast Notification Z-Index Issue
**Версия:** 1.18.132
**Проблема:** Уведомления (Toast) перекрывались модальными окнами и шапкой, так как рендерились в потоке документа.
**Причина:** Отсутствие React Portal и низкий z-index.
**Решение:** Перенесли рендер Toast в `createPortal(..., document.body)` и подняли z-index до 9999.
**Статус:** Исправлено

## 20.01.2026 - Critical Syntax Error (500) в BuyerOrdersList
**Версия:** 1.18.129
**Проблема:** При загрузке страницы закупщика возникала ошибка 500 (Unexpected token).
**Причина:** При автоматическом редактировании файла была удалена закрывающая скобка компонента и блока `return`.
**Решение:** Полностью перезаписан файл с корректным синтаксисом.
**Статус:** Исправлено

## 19.01.2026 - Исчезновение комментария закупщика при сохранении/чтении
**Версия:** 1.18.133
**Проблема:** Закупщик вводит комментарий в режиме "Изменить", сохраняет, видит его в UI, но после перезагрузки поле пустое. В БД при этом данные есть.
**Причина:** 
1. `BuyerOrderRow` передавал в детали неполный объект `myOffer` из списка (без поля `comment`). 
2. `useEffect` в деталях срабатывал при переключении `isEditing` и затирал стейт старыми данными из пропсов до завершения рефетча.
**Решение:** 
1. В `BuyerOrderRow` реализован поиск `detailedMyOffer` внутри уже загруженных полных деталей заказа.
2. В `BuyerOrderDetails` `useEffect` теперь реагирует только на реальное изменение объекта `myOffer` (после успешного рефетча), исключая гонку состояний при переключении режимов.
**Статус:** Исправлено

## 19.01.2026 - Ошибка "Вы уже отправили предложение" при отказе
**Версия:** 1.18.135
**Проблема:** При попытке нажать "Отказаться" (если оффер уже был, например, черновик), вылетал alert с ошибкой дубликата.
**Причина:** Функция `handleSubmitOffer` всегда вызывала `createOffer` (INSERT), не проверяя наличие существующей записи в таблице `offers`.
**Решение:** В `handleSubmitOffer` добавлена проверка через `getMyOffer`. Если оффер существует — вызывается `editOffer` (UPDATE) с новым статусом, иначе — `createOffer`.
**Статус:** Исправлено

## 19.01.2026 - Рассинхрон счетчиков "Архив" и "КП у клиента" у Менеджера
**Версия:** 1.18.132
**Проблема:** Счетчик архива показывал `+2`, хотя в списке было 10+ заказов. Заказы "КП отправлено" отображались не в тех табах.
**Причина:** Разная логика фильтрации в компоненте `AdminInterface` (UI) и SQL-функции `getStatusCounts` (подсчет). Статус "Выполнен" не считался архивом, а "КП отправлено" считался активным.
**Решение:** Синхронизированы маппинги статусов. "КП отправлено" возвращен в "КП у клиента" (как активная сделка), "Выполнен" перенесен в "Архив" (финальный статус). Обновлена функция `getStatusCounts`.
**Статус:** Исправлено

## 18.01.2026 - Ошибка доступа RLS (401) к Чек-листу
**Версия:** 1.18.128
**Проблема:** При попытке загрузить или сохранить чек-лист возникала ошибка `401 Unauthorized`.
**Причина:** Для новой таблицы `admin_checklist` не были настроены политики RLS, а так как авторизация в проекте кастомная (не через Supabase Auth), стандартный доступ был закрыт.
**Решение:** Отключен RLS (`ALTER TABLE ... DISABLE ROW LEVEL SECURITY`) и выданы права `GRANT ALL` для ролей `anon` и `authenticated`.
**Статус:** Исправлено

## 18.01.2026 - Ошибка PGRST204 (subItems column not found)
**Версия:** 1.18.128
**Проблема:** При сохранении чек-листа Supabase возвращал ошибку `Could not find the 'subItems' column`.
**Причина:** В коде React использовался camelCase (`subItems`), а в базе данных — snake_case (`sub_items`). При отправке объекта целиком Supabase пытался записать несуществующее поле.
**Решение:** В методах API (`resetChecklist`, `upsertChecklistItem`) добавлена явная фильтрация и маппинг полей перед отправкой.
**Статус:** Исправлено

## 18.01.2026 - Критическая ошибка верстки (500) в BuyerOrderRow
**Версия:** 1.18.125
**Проблема:** Белый экран (Internal Server Error) при открытии списка заказов закупщика.
**Причина:** При рефакторинге компонента случайно был продублирован блок `return (` и открывающий `div`, что сломало синтаксис JSX.
**Решение:** Удален дублирующийся код.
**Статус:** Исправлено

## 18.01.2026 - Нечитабельный UI на мобильных устройствах
**Версия:** 1.18.123-125
**Проблема:** 
1. Таблицы (`OperatorOrderItems`, `BuyerItemCard`) сжимались до нечитаемого состояния (по одной букве в строке).
2. Кнопки действий вылезали за пределы экрана.
3. Табы навигации обрезались без возможности прокрутки.
**Причина:** Использование жестких сеток (`grid-cols-[...]`) и фиксированных отступов, не рассчитанных на ширину 375px.
**Решение:** 
1. Реализован адаптивный дизайн: Таблицы превращаются в Карточки (Card View) на мобильных.
2. Второстепенные действия (Копировать, Отказаться, Чат) спрятаны в выпадающее меню ("Три точки" или "Menu").
3. Добавлен `overflow-x-auto` для табов и `break-words` для длинных названий.
**Статус:** Исправлено

## 18.01.2026 - Сброс цены оффера при редактировании
**Версия:** 1.18.122
**Проблема:** При нажатии "Изменить" цена оффера сбрасывалась на 0 или не сохранялась после ввода.
**Причина:** Конфликт приоритетов полей в функции маппинга (`item.sellerPrice` vs `item.BuyerPrice`). Значение undefined перезаписывало существующую цену.
**Решение:** В `edit.ts` установлен строгий приоритет: `BuyerPrice` (ввод) -> `sellerPrice` (БД) -> 0. Добавлены проверки на undefined.
**Статус:** Исправлено

## 17.01.2026 - Ошибка TypeError (kp_count) на Дашборде Закупщика
**Версия:** 1.18.118
**Проблема:** При открытии дашборда закупщика возникала ошибка `TypeError: Cannot read properties of undefined (reading 'kp_count')`.
**Причина:** SQL-функция `get_buyer_dashboard_stats` возвращала плоский объект с данными, в то время как фронтенд ожидал вложенную структуру `{ personal: {...}, department: {...}, leaders: {...} }`.
**Решение:** Обновлена SQL-функция в базе данных (и файл миграции), чтобы возвращаемый JSON соответствовал интерфейсу `BuyerDashboard`.
**Статус:** Исправлено

## 17.01.2026 - Двойная загрузка файлов и Race Condition в Dropzone
**Версия:** 1.18.116
**Проблема:** 
1. При сбросе файла на позицию он добавлялся и в позицию, и в общие файлы.
2. При сбросе пачки файлов загружался только один.
**Причина:** 
1. Событие `drop` всплывало от дочернего элемента к глобальному контейнеру.
2. Асинхронные обновления стейта в цикле `forEach` перезаписывали друг друга из-за замыкания.
**Решение:** 
1. Добавлен `event.stopPropagation()` в локальные обработчики `onDrop`.
2. Логика загрузки переписана на `await Promise.all()` с единичным обновлением стейта.
**Статус:** Исправлено

## 17.01.2026 - Ошибка 404/400 при утверждении заказа Менеджером
... (остальное без изменений)
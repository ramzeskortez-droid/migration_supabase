# Version History

## 1.4.8 - Dynamic Brands & Cleanup
- **Codebase Refactor:** 
  - Deleted `constants/cars.ts` (Removed hardcoded car lists).
  - Updated `NewOrderForm` to fetch brands dynamically from the database (`SupabaseService.getBrandsList`).
- **Test Data Generation:** 
  - `seedOrders` now uses real brands from the DB instead of a static array.
  - Removed "Car Model" generation logic (set to empty string) to align with the new data model.

## 1.4.7 - Enhanced Test Data Generation
- **Supabase Service:** 
  - Upgraded `seedOrders` to generate realistic random data for testing.
  - **Features:** Random email subjects (6 chars), phone numbers (+7 999...), client names, delivery addresses, and deadlines (Feb 2026).
  - **Items:** Orders now contain 1-3 random items with varied names, brands, and articles.

## 1.4.6 - Admin Tools & Stability
- **Admin Interface:**
  - Fixed "Clear DB" and "Seed Orders" buttons which were crashing due to undefined loading state.
  - "Seed Orders" now correctly assigns generated orders to **Operator 1 (op1)**, ensuring visibility in the demo account.
- **Supabase Service:**
  - `deleteAllOrders`: Added manual cascade delete fallback if `reset_db` RPC fails.
  - `seedOrders`: Added `ownerToken` parameter.

## 1.4.5 - Critical Bug Fixes (Data Mapping)
- **Supabase Service:** 
  - Fixed a critical bug in `getOrders` where `items` and `offers` were referenced incorrectly.
  - Added `offeredQuantity` mapping to `getOrders` to ensure offers are visible in the Manager Interface even during initial load/fallback.
  - Verified RLS policies are active and functioning correctly.

## 1.4.4 - Sorting & Formatting
- **Admin Interface:**
  - **Sorting:** "New" orders now sort by **Offer Count** (descending) by default, highlighting orders with more activity. All other tabs sort by **Last Status Change** (descending).
  - **Formatting:** Time column now displays full seconds (`HH:mm:ss`).

## 1.4.3 - Sort by Status Time
- **Database:** Added `status_updated_at` column to `orders` table.
- **Admin Interface:** 
  - Added "Time" column to the listing.
  - Implemented smart sorting: 
    - "New" tab -> Sort by Creation Date (desc).
    - Other tabs -> Sort by Status Change Time (desc).
  - This ensures that recently approved/processed orders always appear at the top of their respective lists.

## 1.4.2 - UX Fix
- **Admin Interface:** Explicitly force `expandedId` to persist after order approval to ensure the order stays open in the new tab.

## 1.4.1 - UX Polish
- **Admin Interface:** Fixed "vanishing order" issue during approval. Switched from full optimistic tab switching to "confirm-then-switch" to avoid race conditions with server-side status updates. Order now stays expanded and correctly moves to the next tab.

## 1.4.0 - Server-Side Calculations
- **Database:** Added Computed Columns `total_cost` and `goods_cost` to `offer_items` table. Logic is now centralized in PostgreSQL (`add_server_calculations.sql`).
- **Client Interface:** Frontend now consumes pre-calculated totals from the server, improving security and consistency. Includes fallback to client-side math for optimistic UI.

## 1.3.1 - Delivery Logic Fix
- **Client Interface:** Fixed delivery cost calculation logic. Delivery rate is now treated as a *fixed cost per position* (line item), not multiplied by item quantity.

## 1.3.0 - Performance Optimization
- **Admin Interface:** Implemented "Instant Approval" for Orders.
  - Replaced multiple sequential requests with a single RPC call (`approve_order_winners`).
  - Added Optimistic UI: Tab switches immediately, background process handles the data.
- **Database:** Added `approve_order_winners` stored function.
- **Schema:** Enforced existence of `delivery_rate` column in `offer_items`.

## 1.2.3 - Hotfix for Delivery Rate
- **Supabase Service:** Added fallback mechanism for `delivery_rate`. If the column is missing (migration not applied), it falls back to saving cost in `delivery_days` to prevent data loss and UI breakage.

## 1.2.2 - Bug Fixes
- **Admin Interface:**
  - Fixed a bug where Admin Delivery Rate (Cost) was not saving correctly (was overwriting Delivery Days).
  - Ensured "Total Delivery" is correctly calculated and persisted.

## 1.2.1 - Backend Logic Upgrade
- **ID Generation (Server-Side):**
  - Orders now get sequential integer IDs (1, 2, 3...) generated by `getNextId`.
  - Offers get composite IDs `[OrderId]-[Count]` (e.g., 5-1, 5-2).
- **Google Sheets UX:**
  - Implemented `setupValidations` to auto-generate Dropdown lists for Status columns (Admin, Client, Supplier).
  - Statuses are now strictly typed via `STATUS_OPTS_*` constants.

## 1.2.0 - UI/UX Synchronization with Google Script Logic
- **Data Layer (`sheetService.ts`):**
  - Fixed `statusSupplier` mapping (was `statusSeller`).
  - Implemented `deriveWorkflowStatus` to synthesize a unified status from Admin/Client/Supplier columns.
  - Aligned status strings with Google Script logic (e.g., "КП отправлено", "Подтверждение от поставщика").
- **Types (`types.ts`):**
  - Added 'КП отправлено' to `WorkflowStatus` type.
- **UI Improvements (`AdminInterface`, `ClientInterface`):**
  - Implemented dynamic color coding for rows based on status (Green/Red/Yellow/Blue/Gray).
  - Aligned visuals with the backend "Status Matrix".

## 1.1.0 - Initial Production Release
- Complete flow: Client Order -> Supplier Offer -> Admin Approval -> Client Purchase.
- Telegram broadcasting integration.
- Optimistic UI updates.
- Role-based interfaces (Client, Admin, Supplier).

## 1.0.0 - Prototype
- Basic CRUD operations.
- Google Sheets integration.

# Version History

## 1.18.108 - Critical Fix: Chat Query Column
- **API (core.ts):** Исправлен запрос `getChatMessages`. Удалено обращение к несуществующей колонке `recipient_role`, которое приводило к сбою загрузки сообщений (ошибка 400, "пустой чат").

## 1.18.107 - Fix: Legacy Message Visibility
- **Fix:** Исправлена проблема видимости старых сообщений (или сообщений без UUID) для Закупщика. Теперь поиск осуществляется по имени текущего пользователя ('Buyer Name'), а не по имени ветки ('Оператор'), что гарантирует нахождение сообщений даже при отсутствии ID.

## 1.18.105 - Fix: Strict Chat Separation (Buyer)
- **Logic:** В `getGlobalChatThreads` реализована жесткая группировка сообщений для Закупщика на два канала: "Оператор" и "Менеджер". Имя последнего автора больше не влияет на группировку.
- **UI:** В `BuyerGlobalChat` заголовки тредов зафиксированы ("Чат с Оператором" / "Чат с Менеджером").
- **Privacy:** Усилена логика скрытия чатов Оператора от Менеджера.

## 1.18.104 - Fix: Chat Message Filtering
- **API (core.ts):** Исправлена ошибка в логике фильтрации `getChatMessages` при использовании `interlocutorRole`. Ранее использование `.in()` ошибочно исключало исходящие сообщения закупщика. Заменено на комплексный `.or()`.

## 1.18.103 - Fix: Chat Thread Separation & Visibility
- **Logic:** Внедрено строгое разделение чатов на ветки "Оператор" и "Менеджер".
- **API:** `getChatMessages` теперь поддерживает фильтрацию по `interlocutorRole`.
- **UI:** Кнопка "Оператор" у Закупщика теперь явно открывает ветку с Оператором.
- **Privacy:** Менеджер больше не видит переписку Закупщика с Оператором.

## 1.18.102 - Hotfix: BuyerGlobalChat Props
- **Fix:** Исправлены `ReferenceError` в `BuyerGlobalChat.tsx`:
  - `handleNavigateToOrder` -> `handleNavigate`
  - `currentUserName` -> `currentSupplierName`

## 1.18.101 - Hotfix: Chat Props Destructuring
- **Fix:** Добавлена пропущенная деструктуризация `supplierId` и `currentUserId` в `ChatWindow.tsx`, вызывавшая `ReferenceError`.

## 1.18.100 - Hotfix: GlobalChat Navigation
- **Fix:** Исправлен `ReferenceError` в `GlobalChatWindow.tsx`, вызванный неправильной передачей колбэка навигации.

## 1.18.99 - Миграция чата на UUID идентификацию
- **Database:**
  - В таблицу `chat_messages` добавлены колонки `sender_id` и `recipient_id`.
  - Выполнена миграция старых сообщений: ID заполнены на основе имен (Best Effort).
- **Service Layer (`api/chat`):**
  - Обновлены функции отправки (`sendChatMessage`) и чтения (`getChatMessages`), теперь они используют UUID для точной идентификации участников.
  - Поддержана обратная совместимость (fallback на имена) для старых сообщений.
- **UI Components:**
  - `ChatWindow`: Научился работать с UUID собеседника (`supplierId`).
  - `BuyerGlobalChat`: Теперь передает `buyerAuth.id` при отправке сообщений.
  - `GlobalChatWindow`: Реализована навигация по чатам на основе UUID, что позволяет иметь отдельные ветки переписки с разными закупщиками внутри одного заказа.
  - `AdminItemsTable`: Кнопка чата теперь открывает конкретный тред закупщика по его ID.

## 1.18.96 - Фикс "Фантомных" сообщений и счетчиков
- **Chat Logic:**
  - `BuyerGlobalChat.tsx`: Теперь имя текущего закупщика (`currentUserName`) корректно передается в окно чата. Это устранило баг, когда отправленные сообщения исчезали из списка после обновления (потому что сохранялись под именем "Закупщик", а фильтр искал "Buyer Name").
  - `management.ts`: Исправлена логика сброса непрочитанных. Теперь Закупщик помечает прочитанными сообщения не только от Админа, но и от Оператора/Менеджера.

## 1.18.95 - Финальные правки логики Чатов
- **Chat:** В `getGlobalChatThreads` исправлена фильтрация. Теперь закупщик видит чаты от менеджера, оператора и админа, сгруппированные корректно.

## 1.18.94 - Разделение веток чата для Закупщика
- **Chat:** В `BuyerGlobalChat` добавлена логика разделения чатов с Оператором и Менеджером. Теперь закупщик видит, с кем именно он общается.

## 1.18.93 - Финальный фикс множественного редактирования
- **Logic:** Исправлена ошибка сохранения при множественном редактировании позиций (Race Condition).

## 1.18.92 - Paranoid Verification
- **Update Logic:**
  - В `updateOrderJson` добавлена "Параноидальная проверка": сразу после `update` скрипт делает `select` по тому же ID и выводит в консоль реальное значение из БД.
  - В `saveEditing` добавлена принудительная инвалидация кеша `order-details`, чтобы UI обновлялся мгновенно без F5.

## 1.18.91 - Логирование и Sequential Update
- **Data Logic:** Последовательное обновление json полей.
- **Debugging:**
  - Добавлено логирование входящих данных в `AdminInterface.tsx` перед сохранением.
  - Добавлено логирование результата каждого обновления в `updateOrderJson`.
- **Logic:**
  - В `updateOrderJson` подтвержден и усилен последовательный режим обновлений с проверкой результата.

## 1.18.90 - Последовательное сохранение позиций
- **Data Logic:**
  - В `updateOrderJson` заменен параллельный `Promise.all` на последовательный цикл `for...of`.
  - Это устраняет проблему "гонки" (Race Condition) и блокировок БД, из-за которой при редактировании нескольких товаров сохранялся только первый.

## 1.18.89 - Debugging Manager Edit
- **Admin Interface:** Добавлены логи для отладки сохранения.

## 1.18.88 - Hotfix: Buyer Pagination Props
- **Pagination:** Исправлен баг пагинации.

## 1.18.87 - Исправление пагинации, сортировки и редактирования
- **Buyer Interface:**
  - Исправлен баг с ограничением в 20 заказов. В список `Virtuoso` добавлен колбэк `endReached`, теперь скролл работает бесконечно.
- **Data Logic:**
  - Полностью переписана логика пагинации (`fetch.ts`). Переход с ID-based курсора на Range-based (Offset). Это решило проблему "сломанной" сортировки, когда при сортировке не по ID следующие страницы не загружались.
  - Исправлена функция `updateOrderJson` (`update.ts`). Вместо опасного удаления и создания позиций заново (что ломало ID и связи с офферами), теперь выполняется точечный `UPDATE` существующих записей. Это починило редактирование заказа Менеджером.

## 1.18.85 - Отображение имени менеджера
- **Admin Interface:**
  - В шапке профиля теперь отображается реальное имя администратора (из токена), а не заглушка "Manager".
  - Имя также корректно передается в чат (GlobalChatWindow), что устраняет путаницу в коммуникации при работе нескольких менеджеров.

## 1.18.84 - Строгая валидация ввода телефона
- **Validation:** Строгая валидация телефона.

## 1.18.83 - Фикс управления инвайтами и телефонами
- **Admin Interface:**
  - В панель "Управление пользователями" добавлена кнопка генерации инвайтов для роли `admin` (Менеджер). Теперь можно приглашать коллег через интерфейс.
- **Registration:**
  - Уточнена валидация телефона: длина строго от 10 до 15 цифр.

## 1.18.82 - Валидация телефона и регистрация Менеджеров
- **RegisterForm:**
  - Внедрена валидация номера телефона (минимум 10 цифр).
  - Разрешена регистрация для роли "Менеджер" (Admin).
- **Auth Service:** Обновлены функции регистрации для поддержки роли `admin`.
- **LoginForm:** Ссылка "Регистрация" теперь отображается для всех ролей.

## 1.18.81 - Восстановление Регистрации
- **Auth:** Восстановлена регистрация.

## 1.18.80 - Оптимизация StartPage и навигации
- **Performance:**
  - Полностью переписан `StartPage.tsx`: удалены тяжелые анимации фона (blur, mix-blend-mode), которые вызывали фризы GPU.
  - Дизайн страницы входа упрощен до стиля "Clean SaaS" (bg-slate-50, белые карточки без glassmorphism).
- **Architecture:**
  - Внедрен компонент `MainLayout.tsx` для защищенных страниц.
  - Логика рендеринга `Header` перенесена из `App.tsx` в `MainLayout`. Это устранило визуальный баг, когда шапка оставалась видна при выходе из системы ("залипание").
- **Navigation:**
  - В `useOperatorAuth` заменен `window.location.href` на `useNavigate`, что устранило долгую перезагрузку страницы при выходе.

## 1.18.98 - Исправление просмотра заказов в Архиве у оператора
- **Operator Interface:**
  - Разрешено раскрытие позиций в заказах со статусом "Обработано вручную". Теперь оператор видит выбранных лидеров и варианты в архивных заказах.

## 1.18.97 - Чистка интерфейса и стабилизация правил Git
- **Rules:** Добавлен запрет на цепочки команд с `git commit --amend` для стабильности работы агента.
- **UI Clean-up:** Кнопки ручного обновления ("Обновить") удалены из интерфейсов Менеджера и Закупщика как избыточные (данные обновляются автоматически).

## 1.18.96 - Logic Fix: Отказ Закупщика и Табы
- **Buyer Workflow:**
  - Оптимизирован процесс отказа от заказа. Кнопка отправки теперь скрывается при обнулении позиций, исключая случайную отправку пустых офферов.
  - Исправлена фильтрация табов: заказы со статусом оффера "Отказ" теперь уходят в **Архив**, а не висят в "Активных торгах".

## 1.18.95 - Critical Fix: Ложное отображение лидеров в Ручном режиме
- **Order Logic:** Исправлен баг с лидерами.
# Version History

## 1.18.137 - Feature: Targeted Orders Highlighting
- **Buyer Interface:**
  - Реализована строгая логика "Адресных заявок":
    - Если заявка назначена *группе* закупщиков — она видна всем участникам группы (с бейджиком).
    - Если заявка назначена *лично* (одному) закупщику — она выделяется **анимированным изумрудным свечением** (без жесткой рамки) в общем списке.
    - Выделение пропадает, как только закупщик подает первый оффер (статус меняется на "В работе").
  - Скрыта видимость "чужих" приватных заказов (строгая изоляция через API).
- **Admin / Operator Interface:**
  - Добавлена колонка-бейдж "Закупщик(и)" с иконкой и счетчиком назначенных исполнителей. При наведении показывается список имен.
- **Fixes:**
  - Исправлен краш `ReferenceError: offerEditTimeout` в Админке.
  - Исправлена проблема с передачей `buyerId` в список заказов, из-за чего не работало определение "своих" заявок.

БЫЛА ПРОБЛЕМА:
Закупщики не замечали срочные/индивидуальные заявки в общем потоке. Не было визуального разделения между "общим котлом" и "личным поручением".

КАК РЕШИЛИ:
1. Внедрили логику `isExclusiveToMe` на фронтенде.
2. Добавили CSS-анимацию `animate-pulse` + `shadow-emerald` для карточки заказа.
3. Обновили SQL-запрос `getOrders` для корректной фильтрации приватности.

## 1.18.135 - UI: Chat Sidebar Counters & Cleanup
- **Global Chat:**
  - В боковую панель чата (Sidebar) добавлены суммарные счетчики непрочитанных сообщений для каждого заказа (`Заказ #ID +N`).
  - Улучшен визуальный стиль табов "Активные" и "Архив": теперь используются круглые бейджи вместо текста в скобках.
- **Operator Interface:**
  - Удалены экспериментальные счетчики сообщений из основного листинга заказов для разгрузки интерфейса.

БЫЛА ПРОБЛЕМА:
В окне чата было сложно ориентироваться, в каком именно заказе есть новые сообщения. Табы выглядели неинформативно.

КАК РЕШИЛИ:
1. В `GlobalChatWindow` внедрен расчет `totalUnread` для каждой группы сообщений.
2. Обновлены стили Tailwind для компонентов табов и строк сайдбара.
3. Откачены изменения в `OperatorOrderRow` по просьбе пользователя.

## 1.18.134 - Logic: P2P Chat Architecture
- **Global Logic:**
  - Полный отказ от групповых чатов ("Все менеджеры", "Все операторы").
  - Переход на строгую P2P архитектуру: каждый диалог уникален для пары пользователей (UUID <-> UUID).
  - Имена и роли собеседников теперь подтягиваются динамически из таблицы `app_users`.
- **API Services:**
  - `getGlobalChatThreads`: Переписан алгоритм группировки тредов. Теперь группировка идет по `interlocutor_id`.
  - `getChatMessages`: Фильтрация сообщений теперь строго по паре ID отправителя и получателя.
  - `stats.ts`: Заменены все ролевые счетчики на универсальный `getUserUnreadCount(userId)`.
- **UI:**
  - `GlobalChatWindow`: Обновлен для отображения реальных имен сотрудников вместо общих названий ролей.
  - Исправлена логика уведомлений (Real-time) — теперь уведомления приходят только адресату (по ID), а не всей роли.

БЫЛА ПРОБЛЕМА:
Чаты смешивались в "общие котлы" (все операторы видели переписку всех операторов с менеджерами). Это нарушало приватность и создавало путаницу, если над заказом работали разные сотрудники.

КАК РЕШИЛИ:
1. Переписали SQL-запросы в API чата на строгую фильтрацию по парам `sender_id` / `recipient_id`.
2. Внедрили обогащение данных тредов именами из `app_users`.
3. Убрали легаси-код, завязанный на строковые названия ролей в сообщениях.

## 1.18.133 - Fix: Toast Portal
- **Global UI:**
  - Компонент `Toast` переведен на React Portal (`createPortal`). Это окончательно решает проблему перекрытия уведомлений другими элементами интерфейса (шапкой, модалками), так как рендер происходит в корень `body`.

## 1.18.132 - Admin: Brands Export & Toast Fix
- **Admin Interface:**
  - Реализован экспорт таблицы брендов в Excel (.xlsx).
  - Добавлено модальное окно с выбором диапазона дат (Начало - Конец).
  - Интеграция библиотеки `xlsx` для генерации отчетов на клиенте.
- **Global UI:**
  - Исправлен z-index уведомлений Toast (увеличен до 9999), чтобы они не перекрывались шапкой.

## 1.18.131 - UX: Buyer Refusal & Comments
- **Buyer Interface:**
  - **Свернутый отказ:** Карточка позиции со статусом "Отказ" (Quantity = 0) теперь отображается компактно (красный фон, перечеркнутый текст заголовка), скрывая инпуты. Клик по блоку возвращает позицию в работу.
  - **Авто-отказ:** При отправке КП с незаполненными позициями появляется модальное окно с предложением автоматически пометить их как "Отказ".
  - **Валидация:** Поля "Комментарий" и "WeChat ID" подсвечиваются как обязательные (красная обводка) только если введена цена.
- **Manager Interface:**
  - В развернутом оффере добавлены поля "Комментарий" и "WeChat ID" под строкой варианта с возможностью их редактирования.
  - Исправлены стили отображения WeChat ID.
- **Operator Interface:**
  - Добавлен вывод комментария (от закупщика или менеджера) под каждым вариантом в списке товаров.
  - Комментарий включен в текст при копировании (позиции и всего заказа).

## 1.18.127 - Logic: Unit Pricing for Clients
- **Admin Interface:**
  - **Ценообразование:** Итоговая цена для клиента теперь всегда рассчитывается и отображается **за 1 единицу товара** (Unit Price). Убрано умножение на количество во всей системе.
  - **Финансы:** Из калькулятора на странице Финансов удалено поле "Кол-во" и блок расчета "ИТОГО ЗА ПАРТИЮ". Формула теперь нацелена исключительно на стоимость за штуку.
- **Documentation:**
  - Обновлены файлы `Project Description.md` и `Manager Interface.md` с учетом перехода на Unit Pricing.

## 1.18.126 - UI: Copy Buttons & Listing Optimization
- **Global UI:**
  - Добавлены кнопки быстрого копирования (CopyButton) слева от Наименования и Артикула во всех списках товаров (Менеджер, Оператор, Закупщик).
  - Унифицирован стиль Наименования товара: уменьшен шрифт до размера артикула (text-[10px]), но сохранена жирность (font-black).
  - Внедрено жесткое ограничение длины наименования в списках до 40 символов (обрезается с троеточием), полное название доступно при наведении (title).

## 1.18.125 - Fix: deliveryWeeks -> clientDeliveryWeeks Sync
- **Admin Interface:** Исправлена логика редактирования срока — теперь Менеджер обновляет итоговое значение напрямую в БД, что исключает повторное наложение формулы "+ к сроку".
- **Operator Interface:** В функции копирования теперь используются утвержденные менеджером сроки (clientDeliveryWeeks).

## 1.18.124 - Logic: Buyer Delivery Time Calculation
- **Buyer Workflow:** Валидация срока изменена на Min 1. Реализована фиксация client_delivery_weeks при создании оффера.
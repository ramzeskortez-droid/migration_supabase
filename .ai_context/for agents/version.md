# Version History

## 1.18.124 - Logic: Buyer Delivery Time Calculation
- **Buyer Workflow:**
  - **Валидация:** Минимальный порог срока поставки в интерфейсе Закупщика изменен с 4 недель на 1 неделю.
  - **Логика расчета:** Теперь при создании/отправке предложения (`createOffer`) срок поставки для клиента (`client_delivery_weeks`) рассчитывается фиксированно на момент отправки.
  - **Формула:** `client_delivery_weeks` = `Срок Закупщика` + `delivery_weeks_add` (Глобальная настройка Менеджера).
- **Core:**
  - В `create.ts` добавлен предварительный запрос к таблице `exchange_rates` для получения актуального модификатора срока.
  - В `offer_items` записывается вычисленное значение, что защищает старые офферы от изменения глобальных настроек в будущем.

## 1.18.123 - Mobile UI & Core Fixes
- **Operator Interface (Mobile):**
  - **Адаптивная верстка:** Полный рефакторинг таблиц `PartsList` и `OperatorOrderItems` под мобильные устройства (карточный вид вместо сжатых таблиц).
  - **Список заказов:** `OperatorOrderRow` теперь использует стек-лейаут на мобильных, улучшена читаемость.
- **Admin Interface:**
  - **Расчет цен:** В таблице позиций теперь отображается **Итоговая цена за партию** (ранее была за единицу).
  - **Справка:** В разделе "Финансы" добавлен детальный калькулятор с пошаговым объяснением формулы (Конвертация -> Логистика -> Наценка).
  - **UX:** Добавлен визуальный индикатор количества офферов для мобильной версии.
- **Buyer Interface:**
  - **UX:** Вся строка заказа в списке теперь кликабельна (ранее только текст).
  - **Fix:** Исправлена ошибка сохранения цены при редактировании оффера (приоритет `BuyerPrice`).
- **Core:**
  - Исправлено наследование бренда в интерфейсе Оператора (отображается бренд из заявки).

## 1.18.121 - Feature: Official Brands Management
- **Admin Interface:**
  - В разделе "Бренды" добавлены табы "Все бренды" и "Официалы".
  - Реализован чекбокс "Официал" при создании и редактировании бренда.
  - Добавлена визуальная индикация официальных брендов в списке (иконка щита, цветовое выделение).
- **Global UI Styling:**
  - Реализована глобальная подсветка официальных брендов (Amber color + Underline + Tooltip).
  - Поддержка в интерфейсе Оператора (`OperatorOrderItems`).
  - Поддержка в интерфейсе Закупщика (`BuyerItemCard`).
  - Поддержка в интерфейсе Менеджера (`AdminItemsTable`).
- **Core Logic:**
  - Создан хук `useOfficialBrands` для кеширования списка официалов.
  - Обновлены API функции (`addBrand`, `updateBrand`, `getBrandsFull`, `getOfficialBrands`).
  - В `types.ts` добавлено поле `official` для интерфейса `Brand`.

## 1.18.120 - Feature: Offer Amendment & Locking System
- **Buyer Workflow:**
  - Реализована кнопка "Изменить / Дополнить" для уже отправленных предложений.
  - Внедрена система блокировок (`locked_at` в БД), оповещающая менеджера о процессе правки.
  - Добавлена логика автоматического возврата из таба "Архив / Отказ" в "В торгах" при успешном исправлении предложения.
  - Внедрена защита от правок в последний момент перед дедлайном (скрытие кнопки за `Timeout + 2 мин`).
- **Database & API:**
  - В таблицу `offers` добавлена колонка `locked_at`.
  - Добавлены RPC-функции `lock_offer` и `unlock_offer`.
  - В таблицу `offer_items` добавлен уникальный индекс `(offer_id, order_item_id)` для стабильного обновления данных через `upsert`.
  - В `fetch.ts` добавлена загрузка поля `weight` для офферов (ранее сбрасывалось).
- **Admin Interface:**
  - В настройки добавлена регулировка времени на редактирование (таймаут).
  - (В процессе) Реализация визуальных оверлеев на офферах при активном `locked_at`.

## 1.18.119 - UI Polishing: Neutral Initial Validation
- **Buyer Interface:**
  - Поля закупщика теперь выглядят нейтрально (без красных рамок и звездочек) при открытии заказа.
  - Валидация активируется точечно только для тех позиций, где введена цена (> 0).
- **Fixes:**
  - Исправлена ошибка загрузки нескольких файлов (race condition) и двойной дроп.
  - Улучшено позиционирование уведомлений (Toast) через Portals.

## 1.18.118 - Fix: Buyer Dashboard Data Structure
# Технический глоссарий и архитектурные понятия

В этом документе собраны ключевые программные термины, описание структуры данных и системных механизмов платформы. Документ обязателен для ознакомления перед внесением изменений в бэкенд или логику обработки данных.

---

## 1. Инфраструктура (Self-Hosted)

### 1.1. API Gateway (Kong)
- **Порт:** `8000`.
- **Роль:** Центральный вход для всех запросов к Supabase. Требует обязательной передачи заголовка `apikey`.
- **Ошибка "Invalid authentication credentials":** Возникает, если запрос идет без ключа (например, прямой переход в браузере). Это нормальное поведение.

### 1.2. Supabase Studio (Dashboard)
- **Внешний порт:** `8001` (проксируется через Nginx).
- **Внутренний порт:** `8002` (Docker контейнер `studio`).
- **Безопасность:** Защищен `Basic Auth` на уровне Nginx. Логин/Пароль хранятся в файле `.htpasswd` на сервере.

### 1.3. Edge Runtime & Proxy
- **Технология:** Deno.
- **Особенности:** Функции (Edge Functions) используют `Deno.createHttpClient({ proxy: ... })` для обхода региональных блокировок при обращении к Groq API.
- **Локальный воркер:** В некоторых случаях используется Node.js воркер на порту `3000` для более сложного парсинга.

---

## 2. Идентификаторы и Безопасность

### 2.1. UUID vs ID
- **UUID:** Используется для пользователей (`app_users.id`).
- **BIGINT (ID):** Используется для заказов и позиций (`orders.id`, `order_items.id`).
- **Важно:** При передаче ID в RPC-функции через JS, их часто нужно приводить к типу `Number` или `BigInt`.

### 2.2. Токены (Authentication)
- **owner_token / user_token:** Уникальные строковые ключи пользователей.
- **Механика:** Токен является одновременно и паролем, и идентификатором. По нему происходит изоляция данных (RLS) и авторизация без классического Email/Password.

### 2.3. locked_at (Система блокировок)
- **Где:** Таблица `offers`.
- **Значение:** Timestamp начала редактирования оффера закупщиком.
- **Логика:** Оффер считается заблокированным, если `NOW() - locked_at < offer_edit_timeout`. В это время Менеджер видит предупреждение и не может менять статус Лидера.

---

## 3. Структура Данных (Database Schema)

### 3.1. orders (Заказы)
- `status_manager`: Внутренний статус для логики (В обработке, КП готово и т.д.).
- `status_client`: Публичный статус, видимый клиенту.
- `order_files`: JSONB массив объектов `{name, url, type}`. Общие документы заявки.

### 3.2. offer_items (Предложения)
- **Уникальный индекс:** `(offer_id, order_item_id)`. Предотвращает дублирование предложений от одного закупщика на одну позицию.
- `is_winner`: Флаг, устанавливаемый менеджером ("Лидер").
- `admin_price`: Итоговая цена в рублях, рассчитанная или скорректированная менеджером.
- `client_delivery_weeks`: Зафиксированный срок доставки для клиента (не меняется при изменении глобальных настроек).

### 3.3. system_settings (Глобальные настройки)
- Таблица "Ключ-Значение".
- `offer_edit_timeout`: Время сессии редактирования в минутах.
- `buyer_required_fields`: Мапа обязательных полей для закупщика.

---

## 4. Бизнес-логика и Алгоритмы

### 4.1. Pricing Engine v2 (Формула цены)
Итоговая цена клиента (`admin_price`) рассчитывается динамически до момента выбора Лидера:
`Цена = ((Закуп_CNY * Курс_CNY_RUB) + (Вес * Тариф_Дост_$ * Курс_USD_CNY * Курс_CNY_RUB)) * (1 + Наценка_%)`
*После выбора Лидера цена фиксируется в БД и не пересчитывается.*

### 4.2. Workflow Status Mapping
Логика "Шагов" (Workflow) объединяет несколько полей:
- **"Идут торги"**: Есть хотя бы один оффер, статус заказа "В обработке".
- **"ГОРИТ"**: Заказу более 3-х дней, офферов нет.
- **"КП готово"**: Менеджер нажал "Утвердить", статус сменился в БД.

### 4.3. Механизм Upsert (Обновление данных)
Для сохранения предложений используется метод `.upsert(data, { onConflict: 'offer_id, order_item_id' })`.
Это позволяет закупщику обновлять цены, не зная внутренних ID строк `offer_items`, опираясь только на связь с позицией заказа.

---

## 5. Синхронизация и Real-time

### 5.1. Realtime (Postgres Changes)
- **Offers:** Подписка на `UPDATE`, чтобы Менеджер мгновенно видел начало/конец редактирования закупщиком.
- **Chat:** Подписка на `INSERT` в `chat_messages` для мгновенных уведомлений.
- **Требование:** Таблицы должны иметь `REPLICA IDENTITY FULL` для корректной передачи старых и новых значений (`old` / `new` в payload).

### 5.2. Polling (Опрос сервера)
- Используется как страховочный механизм (каждые 5-30 сек) для обновления счетчиков табов и статусов, если Realtime-соединение было разорвано.

---

## 6. Технологический стек (Frontend)
- **State Management:** React Query v5. Активно использует `invalidateQueries(['orders'])` для мгновенного обновления списков после мутаций.
- **Virtualization:** `react-virtuoso`. Используется для рендеринга списков в сотни заказов без деградации FPS.
- **UI:** Tailwind CSS + Lucide Icons. Все оверлеи реализованы через абсолютное позиционирование внутри `relative` контейнеров с `backdrop-blur`.
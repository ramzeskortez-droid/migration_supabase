# Описание Интерфейса: Оператор (`/operator`)

Рабочее место для создания и первичной обработки заявок. Является "фронт-офисом" системы.
Реализовано в компоненте: `components/OperatorInterface.tsx`.

### 1.1. Аутентификация
- **Компонент:** `OperatorAuthModal.tsx`
- **Действия:**
    - **Ввод токена вручную:** Пользователь вводит строку -> вызов `SupabaseService.loginWithToken(token)`.
    - **Кнопки "Демо":**
        - **Женя (op1)** и **Ваня (op2)**.
        - Клик -> Мгновенный вход под соответствующим именем.
    - **Важно:** Вход разрешен только после одобрения менеджером (status='approved'). Если статус 'pending', выводится сообщение "Ваш аккаунт на проверке".

## 2. Центральная панель: Обработка Заявок
Компоненты: `OrderInfoForm`, `PartsList`, `AiAssistant`, `SystemStatusHorizontal`.

### 2.0. Быстрый тест (Quick Fill)
- **Элемент:** Кнопка **"Быстрый тест"** (иконка молнии) в заголовке формы `OrderInfoForm`.
- **Поведение:** Мгновенно заполняет метаданные заказа (Имя, Телефон, Почта, Адрес, Тема) случайными реалистичными данными и добавляет в список **ровно 2 позиции** со случайными брендами из базы данных и сгенерированными артикулами. Предназначена для ускоренного тестирования функционала.

### 2.1. ИИ-Ассистент (`AiAssistant.tsx`)
- **Поле ввода:** Textarea для вставки произвольного текста заявки (из мессенджера или почты).
- **Кнопка "Эмуляция":** Вставляет в поле ввода эталонный сложный текст заявки (с таблицей, контактами и контекстом) для проверки качества распознавания.
- **Кнопка "Распознать через AI":** Отправляет текст в Groq API (LLaMA 3).
- **Интеграция с почтой:** Автоматически принимает текст из виджета "Почта" при нажатии кнопки "В Ассистент".

### 2.2. Статус системы (`SystemStatusHorizontal.tsx`)
Черная горизонтальная панель под кнопками ассистента.
- **Показатели:** 
    - Лимит токенов (AI): Текущее потребление в минуту.
    - Лимит запросов: Количество обращений к API Groq.
    - Всего запросов: Счетчик за сессию.
- **Таймеры:** Оранжевый счетчик "Сброс Хс" показывает время до очистки минутных лимитов.

---

## 3. Правая панель: Почтовый ящик (`EmailWidget.tsx`)
Заменяет старый сайдбар логов. Служит для прямого приема заявок из Gmail.

### 3.1. Вкладки
1. **Новые:** Письма, требующие обработки. Появляются мгновенно через Realtime.
2. **Архив:** Письма, которые уже были переданы в AI или помечены как обработанные.

### 3.2. Действия
- **В Ассистент:** Копирует ТЕМУ и ТЕЛО письма в поле ввода AI, меняет статус письма на `processed` (уходит в архив).
- **В корзину:** Скрывает письмо из списка (статус `ignored`).

---

## 4. Правая панель (нижняя часть): Список Заказов (Архив)Компонент: `OperatorOrdersList.tsx`.

### 3.1. Загрузка данных
- **Хук:** `useEffect` с зависимостью `refreshTrigger`.
- **Запрос (`SupabaseService.getOrders`):**
    - `SELECT * FROM orders WHERE owner_token = '...'` (Изоляция данных).
    - Подгружает (join) `order_items` и `offers` (для отображения статусов и тем).
    - Пагинация (Infinite Scroll) через курсор.
- **Сортировка:** По умолчанию `id` (DESC) — новые сверху.

### 3.2. Табы (Фильтры статусов)
- **В обработке:** `status_admin = 'В обработке'`.
- **Обработанные:** `status_admin = 'КП готово'`.
- **Успешные:** `status_admin = 'Выполнен'`.
- **Забракованные:** `status_admin IN ('Аннулирован', 'Отказ')`.
- *Клик по табу:* Сбрасывает список и делает новый запрос с фильтром.

### 3.3. Строка Заказа (`OperatorOrderRow.tsx`)
Отображает краткую информацию.
- **Колонки:**
    1.  **ID:** Номер заказа (напр. #15).
    2.  **Клиент:** Имя + Телефон.
    3.  **Тема:** Извлекается из комментария первой позиции (`match(/\[Тема: (.*?)\]/)`).
    4.  **Дата:** `createdAt` (форматированная).
    5.  **Статус:** Цветной бейдж.
- **Клик по строке:** Переключает состояние `isExpanded`.
    - Если развернуто -> Загружает полные детали (`SupabaseService.getOrderDetails`), если их еще нет в кеше.

### 3.4. Детали Заказа (Развернутый вид)
- **Блок "Состав заявки":**
    - Рендерится таблица `items`.
    - **Копирование (Экспорт):**
        - Возле каждой позиции есть кнопка **Копировать** (активна в табе "Обработанные").
        - Формат: `№. Позиция: Наим | Бренд | Кол-во | Цена клиента`. Ниже варианты: `Вариант 1: Итого, срок`.
        - Кнопка **"Копировать всё"** в футере заказа собирает весь расчет КП.
    - **Офферы (Варианты):**
        - Отображаются **только если статус заказа — "КП готово"**. В процессе торгов оператор офферы не видит.
    - **Цена (adminPriceRub):**
        - Отображается как `1 250 ₽` (синий бейдж).

---

## 4. Глобальный Чат (`GlobalChatWindow.tsx`)
- **Real-time:** Сообщения приходят мгновенно. 
- **Уведомления:** Если чат закрыт, при новом сообщении (в канал ADMIN) всплывает уведомление с именем отправителя и текстом.
- **Авто-Архивация:** Диалог автоматически перемещается в архив, если с момента **последнего сообщения** прошло 7 дней ИЛИ статус заказа перешел в стадию "КП готово".
- **Удаление:** Кнопка "Удалить" (корзина) позволяет безвозвратно стереть историю переписки по конкретному заказу.
- **Поиск:** В сайдбаре доступно поле ввода для мгновенной фильтрации списка чатов по номеру заказа.

---

## 5. Технические особенности (Data Flow)
1.  **Изоляция:** Весь SQL-запрос списка заказов содержит `WHERE owner_token = current_user.token`. Это гарантирует, что оператор 1 не увидит заказы оператора 2.
2.  **Валидация брендов:** Список брендов загружается один раз при старте (`getBrandsList`) и обновляется при добавлении нового. Это предотвращает создание "мусорных" названий (напр. "Toyot", "Toyata").
3.  **Синхронизация цен:** Цены в интерфейсе оператора появляются *только* после того, как Менеджер нажмет "Выбрать" в своем интерфейсе. Это запускает триггер (в коде менеджера), который копирует цену из `offer_items` в `order_items`.
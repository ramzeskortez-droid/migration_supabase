# Описание Интерфейса: Менеджер (`/admin`)

Бэк-офис системы. Основная роль: управление ценообразованием, выбор поставщиков и контроль воронки.
Реализовано в компоненте: `components/AdminInterface.tsx`.

---

## 1. Навигация (Сайдбар)
Компонент: `AdminSidebar.tsx`.

- **Логотип:** "Manager Panel" (ранее AdminPanel).
- **Кнопки навигации:**
    1.  **Листинг:** Основная таблица заказов.
    2.  **Пользователи:** Раздел модерации и управления участниками.
    3.  **Инвайты:** (НОВОЕ) Генерация одноразовых кодов для регистрации.
    4.  **Бренды:** Справочник разрешенных брендов.
    5.  **Финансы:** Управление курсами и логистикой.
    6.  **Настройки:** Управление обязательностью полей.
    7.  **Статусы:** Справочная информация.

---

## 2. Раздел "Пользователи и Инвайты"
### 2.1. Модерация
- Менеджер одобряет (`approved`) или отклоняет новые регистрации. До одобрения вход заблокирован.

### 2.2. Генерация Инвайтов
- Менеджер выбирает роль (Оператор/Закупщик) и создает уникальный код.
- Код работает только один раз для одной регистрации.
- Позволяет контролировать количество участников системы.

---

## 3. Раздел "Финансы"
Центр управления экономикой платформы. Данные влияют на авторасчет цен во всех заказах.

### 2.1. Поля ввода
- **Курсы валют:**
    - `CNY -> RUB`: Курс юаня к рублю.
    - `USD -> CNY`: Кросс-курс (сколько юаней в 1 долларе). **Критично для логистики**.
- **Добавка к сроку:**
    - `+ к сроку (нед.)`: Количество недель, автоматически добавляемое к сроку поставщика.
- **Логистика:**
    - `Доставка за кг ($)`: Тариф логистики.
- **Наценка:**
    - `Наценка (%)`: Маржинальность платформы.

### 2.2. Расчет цены (Pricing Engine v2)
Формула: `Цена = ((ЦенаЗакупа_CNY * CNY_RUB) + (Вес * Тариф_$ * USD_CNY * CNY_RUB)) * (1 + Наценка/100)`.
Все значения округляются до рубля.

---

## 4. Раздел "Настройки"
Компонент: `AdminSettings.tsx`.
Глобальное управление поведением платформы.

### 4.1. Обязательность полей для Закупщика
- Позволяет менеджеру выбирать, какие поля закупщик **обязан** заполнить перед отправкой предложения.
- **Список доступных полей:** 
    - WeChat ID / номер поставщика
    - Комментарий / Замена / Аналог
    - Кол-во
    - Цена (¥)
    - Вес (кг)
    - Срок (нед)
    - Ваши файлы
- Если галочка стоит, закупщик не сможет отправить оффер, пока поле пустое (или <= 0 для цен/веса).

### 4.2. Режим отладки (DEBUG Mode)
- **Тумблер:** Включает расширенные функции для тестирования.
- **Влияние:**
    - В шапке появляется кнопка "Очистить БД" (удаляет все заказы).
    - В шапке появляются кнопки генерации тестовых заказов (100 / 1000).
    - У Оператора появляется кнопка "Быстрый тест" (автозаполнение формы) и "Эмуляция" (вставка текста email).

---

## 3. Листинг Заказов (Основной экран)
Компонент: `AdminOrdersList.tsx`.

### 3.1. Загрузка данных
- **Real-time:** Используется `polling` (опрос сервера) каждые 5 секунд. Это обеспечивает мгновенное появление новых офферов без перезагрузки страницы.
- **Кеширование:** `staleTime` установлен в 5000 мс.
- **Запрос (`getOrders`):** Подгружает заказы + связанные `offers` (для счетчиков) + `order_items` (для отображения первой позиции).

### 3.2. Колонки Таблицы
Таблица поддерживает интерактивную сортировку по колонкам: № ЗАКАЗА, СРОК ДО, ДАТА СОЗДАНИЯ, ВРЕМЯ.

1.  **№ ЗАКАЗА:**
    - ID заказа в формате `#ID` (Indigo-600).
    - **Стикер:** Если к заказу привязан стикер, рядом с ID отображается цветной кружок.
2.  **ТЕМА ПИСЬМА:**
    - Самая широкая колонка (`1.5fr`).
    - Содержимое берется из комментария первой позиции заказа (`match(/\[Тема: (.*?)\]/)`). Позволяет быстро понять контекст ("Запчасти на Volvo...").
3.  **БРЕНД:** Основной бренд заявки (берется из метаданных заказа).
4.  **ПОЗИЦИЯ:** Наименование первой детали (напр. "Фильтр масляный").
5.  **ДАТА:** Дата создания (`DD.MM.YYYY`).
6.  **ВРЕМЯ:** Время последнего изменения статуса.
7.  **ОФФЕРЫ:**
    - Счетчик предложений.
    - Вид `[2] ОФ.` означает, что получено 2 ответа от закупщиков.
8.  **ПОЗИЦИЙ:**
    - Формат: `Всего / Закрыто`.
    - `Всего`: Общее количество строк в заказе.
    - `Закрыто`: Количество строк, где выбран поставщик-лидер.
    - Если все позиции закрыты, цифра подсвечивается зеленым.
9.  **СТАТУС:** Текущий этап воронки (крайний правый столбец).

---

## 4. Детали Заказа (Раскрытие)
Компонент: `AdminOrderRow` -> `AdminItemsTable`.

При клике на строку заказа она раскрывается. Загружается полная информация (`getOrderDetails`).

### 4.1. Блок "Детали заказа"
- Карточка с информацией о клиенте, телефоне, авто (если есть).
- **Файлы от оператора / поставщиков:** Раздельные блоки вложений.
- **Чат с оператором:** Кнопка в футере блока для быстрого открытия диалога с создателем заявки.
- Кнопка **"Изменить"**: Позволяет редактировать метаданные заказа.
- Кнопка **"Аннулировать"**: Открывает модалку для ввода причины отказа.

### 4.2. Таблица Товаров (`AdminItemsTable`)
...
- **Чат с поставщиком:** Иконка чата рядом с именем закупщика в строке оффера. Позволяет мгновенно открыть переписку по конкретному лоту.
...

- **Структура:**
    - Строка товара (Запрос оператора).
    - Под ней — список предложений (Офферов).
- **Расчет цены (Автоматический):**
    - **Тултип (?):** Возле заголовка "Цена для клиента" доступна всплывающая подсказка с подробной формулой расчета.
- **Генерация данных:**
    - Кнопка **"Создать Тестовые Офферы"**: Доступна, если предложений нет. Генерирует офферы от случайных реальных закупщиков из базы.
- **Ручное управление:**
    - **Карандаш:** Клик по цене включает режим ручного ввода.
    - **Поля:** `adminPrice` (Цена), `deliveryRate` (Тариф), Валюта.
    - Изменение этих полей пересчитывает итог и сохраняет его в стейт.

### 4.3. Кнопка "ВЫБРАТЬ" (Выбор Лидера)
Самый важный элемент интерфейса.

- **Логика:** Работает как переключатель (Toggle). Поддерживается множественный выбор.
- **Ограничение:** Кнопки выбора активны **только** в статусе "В обработке" или "Ручная обработка".
- **Блокировка:** После перехода заказа в стадию "КП готово" и выше, кнопки выбора заменяются на бейджи ("Выбран" / "Закрыто"), а редактирование победителей запрещается (режим "только чтение").

**Алгоритм работы:**
1. **Клик "ВЫБРАТЬ":**
    - **Optimistic UI:** Интерфейс обновляется мгновенно (локальный кеш React Query).
    - **Вызов API:** Выполняется `SupabaseService.updateRank(...)`.
    - **БД (offer_items):** Устанавливается `is_winner = true`, фиксируется `admin_price` и `client_delivery_weeks`.
    - **Синхронизация (order_items):** Итоговая цена и ссылка на фото победителя копируются в таблицу `order_items` (для отображения клиенту).
2. **Клик "ЛИДЕР" (Повторный):**
    - **Optimistic UI:** Выбор снимается мгновенно.
    - **БД (offer_items):** Снимается флаг `is_winner`, обнуляются расчетные поля.
    - **БД (order_items):** Очищается `admin_price` для данной позиции.

### 4.4. Финализация
- **Кнопка "Утвердить КП и Отправить":**
    - Расположена внизу списка товаров.
    - Доступна только если есть офферы.
    - **Чекбокс "Ручная обработка":** Позволяет передать заказ оператору для завершения "вне системы". Кнопка меняет название на "Передать оператору".
    - **Фиксация срока:** При утверждении (или выборе лидера) текущий рассчитанный срок доставки **фиксируется** в БД и больше не зависит от глобальных настроек.
    - **Действие (Стандарт):**
        - Переводит статус заказа в `КП готово` (Internal Status).
        - Заказ остается в табе "КП готово" до тех пор, пока оператор не отправит его клиенту.

---

## 5. Технические особенности
1.  **Инвалидация:** Используется `queryClient.setQueryData` для мгновенного обновления кеша при выборе лидера, а затем `refetch` для синхронизации с сервером.
2.  **Сортировка:** Позиции заказа жестко сортируются по ID, чтобы избежать скачков строк при обновлении данных.
3.  **Табы:**
    - **"КП готово":** Заказы утверждены менеджером, ждут отправки оператором.
    - **"КП у клиента":** (ex-Готов купить) Заказы отправлены клиенту (`КП отправлено`) или клиент уже дал согласие.
# Описание Интерфейса: Менеджер (`/admin`)

Бэк-офис системы. Основная роль: управление ценообразованием, выбор поставщиков и контроль воронки.
Реализовано в компоненте: `components/AdminInterface.tsx`.

---

## 1. Навигация (Сайдбар)
Компонент: `AdminSidebar.tsx`.

- **Логотип:** "Manager Panel" (ранее AdminPanel).
- **Кнопки навигации:**
    1.  **Листинг:** Основная таблица заказов.
    2.  **Финансы:** Экран управления курсами валют.
    3.  **Статусы:** Справочная информация о этапах воронки.

---

## 2. Раздел "Финансы"
Компонент: `AdminFinanceSettings.tsx`.
Центр управления экономикой платформы. Данные влияют на авторасчет цен во всех заказах.

### 2.1. Поля ввода
- **Курсы валют:**
    - `CNY -> RUB`: Курс юаня к рублю.
    - `USD -> RUB`: Курс доллара к рублю.
    - `CNY -> USD`: Кросс-курс.
- **Логистика:**
    - `Доставка за кг ($)`: Базовый тариф логистики.
- **Наценка:**
    - `Наценка (%)`: Маржинальность платформы.

### 2.2. Действия
- **Кнопка "Зафиксировать курсы":**
    - *БД:* `UPSERT INTO exchange_rates (date, ...)` по текущей дате.
    - Логика: Если запись за сегодня уже есть — она обновляется. Если нет — создается новая. Это позволяет сохранять историю курсов (хотя UI пока использует только `latest`).
- **Пример расчета:** Внизу страницы динамически отображается формула расчета цены на примере товара за 100 юаней и весом 2 кг.

---

## 3. Листинг Заказов (Основной экран)
Компонент: `AdminOrdersList.tsx`.

### 3.1. Загрузка данных
- **Real-time:** Используется `polling` (опрос сервера) каждые 5 секунд. Это обеспечивает мгновенное появление новых офферов без перезагрузки страницы.
- **Кеширование:** `staleTime` установлен в 5000 мс.
- **Запрос (`getOrders`):** Подгружает заказы + связанные `offers` (для счетчиков) + `order_items` (для отображения первой позиции).

### 3.2. Колонки Таблицы
Таблица полностью переработана для удобства работы.

1.  **№ ЗАКАЗА:**
    - ID заказа.
    - **Стикер:** Если к заказу привязан стикер, рядом с ID отображается цветной кружок.
2.  **ТЕМА ПИСЬМА:**
    - Самая широкая колонка (`1.5fr`).
    - Содержимое берется из комментария первой позиции заказа (`match(/\[Тема: (.*?)\]/)`). Позволяет быстро понять контекст ("Запчасти на Volvo...").
3.  **БРЕНД:** Основной бренд заявки (берется из метаданных заказа).
4.  **ПОЗИЦИЯ:** Наименование первой детали (напр. "Фильтр масляный").
5.  **ДАТА:** Дата создания (`DD.MM.YYYY`).
6.  **ВРЕМЯ:** Время последнего изменения статуса.
7.  **ОФФЕРЫ:**
    - Счетчик предложений.
    - Вид `[2] ОФ.` означает, что получено 2 ответа от закупщиков.
8.  **ПОЗИЦИЙ:**
    - Формат: `Всего / Закрыто`.
    - `Всего`: Общее количество строк в заказе.
    - `Закрыто`: Количество строк, где выбран поставщик-лидер.
    - Если все позиции закрыты, цифра подсвечивается зеленым.
9.  **СТАТУС:** Текущий этап воронки (крайний правый столбец).

---

## 4. Детали Заказа (Раскрытие)
Компонент: `AdminOrderRow` -> `AdminItemsTable`.

При клике на строку заказа она раскрывается. Загружается полная информация (`getOrderDetails`).

### 4.1. Блок "Детали заказа"
- Карточка с информацией о клиенте, телефоне, авто (если есть).
- Кнопка **"Изменить"**: Позволяет редактировать метаданные заказа (Имя клиента, телефон, бренд).
- Кнопка **"Аннулировать"**: Открывает модалку для ввода причины отказа. Статус переходит в "Аннулирован", причина видна оператору.

### 4.2. Таблица Товаров (`AdminItemsTable`)
Центральное место работы менеджера.

- **Структура:**
    - Строка товара (Запрос оператора).
    - Под ней — список предложений (Офферов) от разных закупщиков на этот товар.
- **Расчет цены (Автоматический):**
    - Для каждого оффера система считает цену для клиента в рублях.
    - *Формула:* `(ЦенаПоставщика * Курс) + (Вес * Тариф * КурсUSD) + Наценка`.
    - Курсы берутся из таблицы `exchange_rates`.
- **Ручное управление:**
    - **Карандаш:** Клик по цене включает режим ручного ввода.
    - **Поля:** `adminPrice` (Цена), `deliveryRate` (Тариф), Валюта.
    - Изменение этих полей пересчитывает итог и сохраняет его в стейт.

### 4.3. Кнопка "ВЫБРАТЬ" (Выбор Лидера)
Самый важный элемент интерфейса.

- **Логика:** Работает как переключатель (Toggle).
- **Клик "ВЫБРАТЬ":**
    1.  Вызывается `SupabaseService.updateRank(..., actionType=undefined)`.
    2.  *БД:* `UPDATE offer_items SET is_winner = true` для выбранного оффера.
    3.  *БД:* Сбрасывает `is_winner = false` для всех остальных офферов по этой позиции.
    4.  **Синхронизация:** Копирует итоговую цену (`admin_price_rub`) в таблицу `order_items`. Это нужно, чтобы Оператор увидел цену.
    5.  *UI:* Кнопка меняет цвет на зеленый ("ЛИДЕР"), строка подсвечивается.
- **Клик "ЛИДЕР" (Повторный):**
    1.  Вызывается `SupabaseService.updateRank(..., actionType='RESET')`.
    2.  *БД:* Снимает флаг `is_winner`.
    3.  *БД:* Очищает цену в `order_items`.
    4.  *UI:* Выбор снимается.

### 4.4. Финализация
- **Кнопка "Утвердить КП и Отправить":**
    - Расположена внизу списка товаров.
    - Доступна только если есть офферы.
    - **Действие:**
        - Проверяет, все ли позиции закрыты лидерами. Если нет — выдает предупреждение.
        - Переводит статус заказа в `КП отправлено` (или `КП готово`).
        - Фиксирует сделку.

---

## 5. Технические особенности
1.  **Инвалидация:** После любого действия (выбор лидера, смена статуса) происходит принудительное обновление данных (`refetch`), чтобы интерфейс всегда отображал актуальное состояние БД.
2.  **Обработка ошибок:** Исправлена ошибка `carYear is not defined`, которая ранее блокировала раскрытие заказа.
3.  **Оптимизация:** Удалены лишние поля (VIN, Год, Кузов) из основной таблицы для упрощения восприятия.
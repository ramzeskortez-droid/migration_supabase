# Описание Интерфейса: Менеджер (`/admin`)

Бэк-офис системы. Основная роль: управление ценообразованием, выбор поставщиков и контроль воронки.
Реализовано в компоненте: `components/AdminInterface.tsx`.

---

## 1. Навигация (Сайдбар)
Компонент: `AdminSidebar.tsx`.

- **Логотип:** "Manager Panel" (ранее AdminPanel).
- **Кнопки навигации:**
    1.  **Листинг:** Основная таблица заказов.
    2.  **Пользователи:** (НОВОЕ) Раздел модерации и управления участниками.
    3.  **Бренды:** Справочник разрешенных брендов.
    4.  **Финансы:** Экран управления курсами валют.
    5.  **Настройки:** (НОВОЕ) Управление поведением системы и обязательностью полей.
    6.  **Статусы:** Справочная информация о этапах воронки.

---

## 2. Раздел "Пользователи"
Компонент: `AdminUsers.tsx`.
Система контроля доступа к платформе.

### 2.1. Вкладка "На модерации"
- Показывает новых зарегистрированных пользователей (статус `pending`).
- **Действия:** Одобрить (статус становится `approved`) или Отклонить (удаление записи).
- До одобрения пользователь не может войти в систему.

### 2.2. Вкладка "Список пользователей"
- Группировка по ролям: Операторы | Закупщики | Менеджеры.
- Отображение: ID, Имя, Телефон, Токен, Дата регистрации.
- Адаптивная верстка с поддержкой длинных имен и телефонов.

---

## 3. Раздел "Финансы"
Центр управления экономикой платформы. Данные влияют на авторасчет цен во всех заказах.

### 2.1. Поля ввода
- **Курсы валют:**
    - `CNY -> RUB`: Курс юаня к рублю.
    - `USD -> CNY`: Кросс-курс (сколько юаней в 1 долларе). **Критично для логистики**.
- **Добавка к сроку:**
    - `+ к сроку (нед.)`: Количество недель, автоматически добавляемое к сроку поставщика.
- **Логистика:**
    - `Доставка за кг ($)`: Тариф логистики.
- **Наценка:**
    - `Наценка (%)`: Маржинальность платформы.

### 2.2. Расчет цены (Pricing Engine v2)
Формула: `Цена = ((ЦенаЗакупа_CNY * CNY_RUB) + (Вес * Тариф_$ * USD_CNY * CNY_RUB)) * (1 + Наценка/100)`.
Все значения округляются до рубля.

---

## 4. Раздел "Настройки"
Компонент: `AdminSettings.tsx`.
Глобальное управление поведением платформы.

### 4.1. Обязательные поля для Закупщика
- Позволяет менеджеру выбирать, какие поля закупщик **обязан** заполнить перед отправкой предложения.
- **Название и Номер поставщика:** При включении этой опции поле становится обязательным во всех интерфейсах закупщиков.

---

## 3. Листинг Заказов (Основной экран)
Компонент: `AdminOrdersList.tsx`.

### 3.1. Загрузка данных
- **Real-time:** Используется `polling` (опрос сервера) каждые 5 секунд. Это обеспечивает мгновенное появление новых офферов без перезагрузки страницы.
- **Кеширование:** `staleTime` установлен в 5000 мс.
- **Запрос (`getOrders`):** Подгружает заказы + связанные `offers` (для счетчиков) + `order_items` (для отображения первой позиции).

### 3.2. Колонки Таблицы
Таблица поддерживает интерактивную сортировку по колонкам: № ЗАКАЗА, СРОК ДО, ДАТА СОЗДАНИЯ, ВРЕМЯ.

1.  **№ ЗАКАЗА:**
    - ID заказа в формате `#ID` (Indigo-600).
    - **Стикер:** Если к заказу привязан стикер, рядом с ID отображается цветной кружок.
2.  **ТЕМА ПИСЬМА:**
    - Самая широкая колонка (`1.5fr`).
    - Содержимое берется из комментария первой позиции заказа (`match(/\[Тема: (.*?)\]/)`). Позволяет быстро понять контекст ("Запчасти на Volvo...").
3.  **БРЕНД:** Основной бренд заявки (берется из метаданных заказа).
4.  **ПОЗИЦИЯ:** Наименование первой детали (напр. "Фильтр масляный").
5.  **ДАТА:** Дата создания (`DD.MM.YYYY`).
6.  **ВРЕМЯ:** Время последнего изменения статуса.
7.  **ОФФЕРЫ:**
    - Счетчик предложений.
    - Вид `[2] ОФ.` означает, что получено 2 ответа от закупщиков.
8.  **ПОЗИЦИЙ:**
    - Формат: `Всего / Закрыто`.
    - `Всего`: Общее количество строк в заказе.
    - `Закрыто`: Количество строк, где выбран поставщик-лидер.
    - Если все позиции закрыты, цифра подсвечивается зеленым.
9.  **СТАТУС:** Текущий этап воронки (крайний правый столбец).

---

## 4. Детали Заказа (Раскрытие)
Компонент: `AdminOrderRow` -> `AdminItemsTable`.

При клике на строку заказа она раскрывается. Загружается полная информация (`getOrderDetails`).

### 4.1. Блок "Детали заказа"
- Карточка с информацией о клиенте, телефоне, авто (если есть).
- **Файлы по заявке:** Список прикрепленных оператором файлов (PDF, Excel, Фото) отображается в нижней части этого блока в виде кликабельных ссылок.
- Кнопка **"Изменить"**: Позволяет редактировать метаданные заказа (Имя клиента, телефон, бренд).
- Кнопка **"Аннулировать"**: Открывает модалку для ввода причины отказа. Статус переходит в "Аннулирован", причина видна оператору.

### 4.2. Таблица Товаров (`AdminItemsTable`)
Центральное место работы менеджера.

- **Структура:**
    - Строка товара (Запрос оператора).
    - Под ней — список предложений (Офферов).
- **Расчет цены (Автоматический):**
    - **Тултип (?):** Возле заголовка "Цена для клиента" доступна всплывающая подсказка с подробной формулой расчета.
- **Генерация данных:**
    - Кнопка **"Создать Тестовые Офферы"**: Доступна, если предложений нет. Генерирует офферы от случайных реальных закупщиков из базы.
- **Ручное управление:**
    - **Карандаш:** Клик по цене включает режим ручного ввода.
    - **Поля:** `adminPrice` (Цена), `deliveryRate` (Тариф), Валюта.
    - Изменение этих полей пересчитывает итог и сохраняет его в стейт.

### 4.3. Кнопка "ВЫБРАТЬ" (Выбор Лидера)
Самый важный элемент интерфейса.

- **Логика:** Работает как переключатель (Toggle). Поддерживается множественный выбор.
- **Синхронизация:** Копирует рассчитанную цену и фото победителя в таблицу `order_items`. Тема письма сохраняется за счет стабильной сортировки позиций по ID.
- **Клик "ВЫБРАТЬ":**
    1.  **Optimistic UI:** Интерфейс обновляется мгновенно.
    2.  Вызывается `SupabaseService.updateRank(...)`.
    3.  *БД:* `UPDATE offer_items SET is_winner = true` для выбранного оффера.
    4.  **Синхронизация:** Копирует итоговую цену последнего выбранного лидера в таблицу `order_items`.
- **Клик "ЛИДЕР" (Повторный):**
    1.  **Optimistic UI:** Выбор снимается мгновенно.
    2.  *БД:* Снимает флаг `is_winner`.
    3.  *БД:* Очищает цену в `order_items`.

### 4.4. Финализация
- **Кнопка "Утвердить КП и Отправить":**
    - Расположена внизу списка товаров.
    - Доступна только если есть офферы.
    - **Действие:**
        - Проверяет, все ли позиции закрыты лидерами. Если нет — выдает предупреждение.
        - Переводит статус заказа в `КП готово` (Internal Status).
        - Заказ остается в табе "КП готово" до тех пор, пока оператор не отправит его клиенту.

---

## 5. Технические особенности
1.  **Инвалидация:** Используется `queryClient.setQueryData` для мгновенного обновления кеша при выборе лидера, а затем `refetch` для синхронизации с сервером.
2.  **Сортировка:** Позиции заказа жестко сортируются по ID, чтобы избежать скачков строк при обновлении данных.
3.  **Табы:**
    - **"КП готово":** Заказы утверждены менеджером, ждут отправки оператором.
    - **"КП у клиента":** (ex-Готов купить) Заказы отправлены клиенту (`КП отправлено`) или клиент уже дал согласие.
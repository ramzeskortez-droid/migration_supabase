# Описание Интерфейса: Закупщик (`/buyer`)

Рабочее место внешнего поставщика (Китая) для поиска заказов и подачи ценовых предложений (офферов).
Реализовано в компоненте: `components/BuyerInterface.tsx`.

---

## 1. Аутентификация
Идентификация происходит по уникальному токену. Вход разрешен только после одобрения менеджером (`status='approved'`).

---

## 2. Подача и Редактирование Предложения

### 2.1. Умный Drag-and-Drop
- **Глобальный:** Можно перетащить файлы в любое место развернутого заказа. Они добавятся в "Общие файлы" предложения. При перетаскивании появляется пунктирная рамка и легкий блюр.
- **Локальный:** При наведении файла на конкретную карточку товара появляется оверлей "Добавить в Позицию #X". Файлы прикрепятся именно к этой строке.

### 2.2. Редактирование (Кнопка "Изменить / Дополнить")
Закупщик может изменить уже отправленный оффер (в табах "В торгах" или "Архив / Отказ"), если менеджер еще не утвердил КП.

- **Логика:**
    - Нажатие кнопки переводит карточку в режим редактирования (инпуты разблокируются).
    - В базе данных фиксируется время начала правки (`locked_at`).
    - **Таймаут:** Сессия редактирования длится согласно настройкам (по умолчанию 5 мин).
- **Ограничения:**
    - Кнопка скрывается, если до автоматического закрытия заказа (3 дня с момента создания) осталось меньше времени, чем `Таймаут + 2 минуты`.
    - Если менеджер утвердил КП, пока закупщик правил — сохранение будет заблокировано с уведомлением.

### 2.3. Валидация полей
- **Динамическая активация:** Поля (Цена, Вес, Срок, Комментарий, WeChat ID) помечаются звездочкой `*` и подсвечиваются красной рамкой **только если в строке введена цена**.
- Если поле "Комментарий" или "WeChat ID" обязательно (настройка Менеджера) и заполнена цена, кнопка "Отправить" блокируется до заполнения этих полей.

### 2.4. Механизм Отказа
- **Свернутый Отказ:** Нажатие на кнопку "Отказаться" (Ban icon) в строке позиции сворачивает её в компактную красную полосу, скрывая все инпуты. Текст становится перечеркнутым.
    - Данные не удаляются, а скрываются. Клик по свернутой позиции возвращает её в работу.
    - Статус отправляется на сервер как `quantity: 0`.
- **Авто-отказ при отправке:** Если закупщик нажимает "Отправить", имея незаполненные позиции (без цены), система показывает модальное окно: "Вы не заполнили X позиций. Пометить их как 'Отказ'?". При подтверждении незаполненные позиции уходят как отказ.
- **Логика последней позиции:** Если закупщик последовательно отказывается от всех позиций в заказе, при нажатии на "Отказаться" у последней активной позиции система автоматически вызывает окно отказа от всего заказа.

---

## 3. Дашборд KPI (`BuyerDashboard.tsx`)
// ... (existing content)

---

## 4. Тулбар и Табы
- **Поиск:** По ID, VIN, имени клиента или авто.
- **Фильтр Брендов:** 
    - **Быстрые теги:** Динамически формируются из брендов, доступных в табе "НОВЫЕ" (за последние 3 дня).
    - **Персистентность:** Выбранные бренды сохраняются в `localStorage` и не сбрасываются при перезагрузке страницы.
- **Система Табов:** Новые, В торгах, Выигранные (статусы: ВЫИГРАЛ, ЧАСТИЧНО), Проигранные, Архив / Отказ (статусы: ОТКАЗ, АННУЛИРОВАН).
- **Фильтр статусов:** Кнопка-фильтр (Popover) внутри табов позволяет фильтровать заказы по под-статусам.
# Описание Интерфейса: Закупщик (`/buyer`)

Рабочее место внешнего контрагента (поставщика в Китае) для мониторинга рынка, поиска заказов и управления ценовыми предложениями (офферами). Интерфейс спроектирован для работы с большими объемами данных и высокой скоростью реакции на новые заявки.

---

## 1. Аутентификация и Доступ
Система использует токенизированный вход без пароля в классическом понимании.

- **Механика входа:** Пользователь вводит "Секретный токен". Система ищет соответствие в таблице `app_users`.
- **Статусы аккаунта:** 
    - `pending`: Аккаунт зарегистрирован, но ожидает проверки менеджером. Вход заблокирован.
    - `approved`: Доступ разрешен.
- **Регистрация:** Требует уникальный инвайт-код (выдается менеджером). При регистрации пользователь сам придумывает свой токен.
- **Безопасность:** Токен сохраняется в `localStorage` как `buyer_auth_token`. При логауте данные очищаются, а кеш запросов React Query сбрасывается.

---

## 2. Дашборд KPI (`BuyerDashboard.tsx`)
Центральный аналитический блок, мотивирующий закупщика повышать эффективность. Обновляется в реальном времени.

- **Источник данных:** RPC функция `get_buyer_dashboard_stats(p_user_id)`.
- **Период:** Весь расчет ведется строго за **текущий календарный месяц**.
- **Ключевые метрики:**
    - **Оборот отдела:** Сумма всех выигранных позиций всеми закупщиками.
    - **КП Выставлено:** Количество уникальных заказов, по которым закупщик подал хотя бы одну цену.
    - **Выигранные сделки:** Заказы, где менеджер выбрал закупщика "Лидером" хотя по одной позиции.
    - **Сумма выигрыша:** Суммарная стоимость `admin_price` только для выигравших позиций.
- **Лидерборд:** Визуальное сравнение текущего пользователя с лучшими сотрудниками. Показывает "разрыв" (Gap) в деньгах и количестве до 1-го места.

---

## 3. Навигация и Тулбар (`BuyerToolbar.tsx`)

### 3.1. Умная фильтрация
- **Поиск:** Полнотекстовый поиск по ID заказа, VIN-номеру, названию клиента или модели автомобиля.
- **Бренды:** 
    - **Быстрые теги:** Топ-5 наиболее часто используемых закупщиком брендов выносятся в кнопки быстрого доступа.
    - **Глобальный фильтр:** Поиск по всем брендам, присутствующим в текущих активных заказах.
- **Сортировка:** Поддерживается сортировка по ID (новизне), дедлайну (срочности) и дате обновления.

### 3.2. Система Табов (Логика фильтрации)
1.  **Новые:** Заказы в статусе "В обработке", созданные менее 3 дней назад, по которым текущий закупщик еще **не подавал** предложений.
2.  **В торгах:** Заказы, по которым оффер подан и находится на рассмотрении.
3.  **Выигранные:** Заказы, где закупщик выбран "Лидером".
4.  **Проигранные:** Заказы, ушедшие в статус "КП готово" и выше, где победил другой поставщик.
5.  **Архив / Отказ:** Глобально завершенные заказы ИЛИ заказы, от которых закупщик явно отказался (статус оффера 'Отказ').

---

## 4. Карточка и Детали Заказа (`BuyerOrderRow.tsx`)

### 4.1. Визуальные индикаторы
- **ID заказа:** Выделен Indigo-600 цветом, жирный шрифт.
- **Дедлайн:** Иконка часов. Если до авто-закрытия (3 дня) осталось мало времени, текст подсвечивается.
- **Стикеры:** Личные цветные метки закупщика. Позволяют классифицировать заказы для себя (например, "Жду ответа от завода"). Видны *только* автору.

### 4.2. Механика Drag-and-Drop (Smart Upload)
В системе реализована двухуровневая система загрузки файлов без лишних кликов:
- **Глобальная зона:** Весь контейнер ордера является приемником. Файлы, брошенные "в пустоту", попадают в общие документы оффера (счета, инвойсы).
- **Локальная зона (Позиция):** При наведении файла на конкретную строку товара появляется оверлей **"Добавить в Позицию #X"**. Файлы прикрепляются точечно к этому товару.
- **Визуал:** При перетаскивании включается пунктирная рамка и легкий блюр (`2px`) фона для фокусировки внимания.

---

## 5. Работа с Предложением (`BuyerOrderDetails.tsx`)

### 5.1. Редактирование и Дополнение (Amend)
Закупщик имеет право корректировать свое предложение до момента финализации заказа менеджером.
- **Кнопка "Изменить / Дополнить":** Разблокирует поля ввода в уже отправленном оффере.
- **Система Блокировок (Locking):** 
    - При нажатии кнопки в БД ставится метка `locked_at`.
    - Менеджер видит индикатор "Закупщик вносит изменения" и не может выбрать позиции этого поставщика, пока тот не закончит.
    - **Таймаут:** Сессия редактирования ограничена (настраивается в админке, обычно 5-10 мин).
- **Защита дедлайна:** Кнопка редактирования исчезает за `Timeout + 2 мин` до автоматического закрытия заказа оператором.

### 5.2. Валидация и Ввод Данных
Интерфейс спроектирован так, чтобы не отвлекать закупщика от позиций, которые он не может поставить.
- **Триггер цены:** Пока поле "Цена" пустое, вся строка считается необязательной. Красные звездочки и рамки отсутствуют.
- **Активация:** Как только введена цена `> 0`, включается строгая проверка обязательных полей (Вес, Срок, SKU) согласно настройкам системы.
- **Ограничения ввода:**
    - Цена: макс 1,000,000 ¥.
    - Вес: макс 1,000 кг.
    - Срок: минимум 4 недели (валидируется при попытке отправки).
- **Инструменты конкуренции:** Если по позиции уже есть другие офферы, закупщик видит подсказки `BEST: [Цена]` и `BEST: [Срок]`.

---

## 6. Коммуникация и Уведомления
- **Чат:** Прямой канал связи с Оператором (по уточнению данных) или Менеджером (по ценам).
- **Уведомления:** Всплывающие Toasts (через Portals) о новых сообщениях или успешном сохранении. Появляются в верхнем правом углу, не перекрывая шапку сайта (`top-24`).
- **Авто-отказ:** Возможность нажать "Отказаться" для всей заявки сразу. Требует подтверждения, переносит заказ в Архив.

---

## 7. Техническая справка для разработчиков
- **Основной компонент:** `src/components/buyer/BuyerInterface.tsx`.
- **Управление данными:** `useOrdersInfinite.ts` (бесконечный скролл с виртуализацией через `react-virtuoso`).
- **Синхронизация:** Поллинг статусов каждые 30 секунд + Realtime подписки на чаты и блокировки.
- **API Методы:** 
    - `createOffer`: Первичная отправка.
    - `editOffer`: Обновление через `upsert` по уникальному индексу `(offer_id, order_item_id)`.
    - `lockOffer / unlockOffer`: Управление состоянием правки.
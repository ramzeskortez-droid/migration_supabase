# Описание Интерфейса: Закупщик (`/buyer`)

Рабочее место внешнего поставщика (Китая) для поиска заказов и подачи ценовых предложений (офферов).
Реализовано в компоненте: `components/BuyerInterface.tsx`.

---

## 1. Аутентификация
Система входа полностью обновлена. Теперь идентификация происходит по уникальному токену, а не по имени.

- **Компонент:** `BuyerAuthModal.tsx`.
- **Проверка:** При загрузке проверяется `localStorage.getItem('buyer_auth_token')`. Если пусто — показывается модалка.

### 1.1. Вкладка "Вход"
- **Поле "Секретный токен":** Пароль для входа.
- **Кнопки Демо:** "Демо 1" / "Демо 2" (подставляют `buy1` / `buy2`). **Мгновенный вход** при клике.
- **Клик "Войти":**
    - Вызов `SupabaseService.loginWithToken(token)`.
    - *БД:* `SELECT * FROM app_users WHERE token = '...' AND status = 'approved'`.
    - Если успех: сохраняет объект пользователя в `localStorage` и закрывает окно.
    - **Важно:** Вход разрешен только после одобрения менеджером (status='approved'). Если статус 'pending', выводится сообщение "Ваш аккаунт на проверке".

### 1.2. Вкладка "Регистрация"
- **Поля:**
    - **Инвайт-код:** Проверка на строгое соответствие `china-nai`.
    - **Имя:** Название компании (макс. 20 символов).
    - **Телефон:** Строго 11 цифр (РФ формат).
    - **Токен:** Придумывается пользователем (макс. 20 символов).
- **Клик "Зарегистрироваться":**
    - Валидация полей.
    - Вызов `SupabaseService.registerUser(...)`.
    - *БД:* `INSERT INTO app_users (name, token, phone, role='buyer')`.
    - Автоматический вход после успешной регистрации.

---

## 2. Дашборд KPI (`BuyerDashboard.tsx`)
Новый центральный элемент интерфейса, заменяющий старую общую статистику рынка. Фокусируется на личной эффективности закупщика.

- **Источник данных:** RPC функция `get_buyer_dashboard_stats(user_id)`.
- **Период:** Текущий календарный месяц.

### 2.1. Общие показатели (TotalKpiCard)
- **Оборот отдела:** Суммарная стоимость всех выигранных КП всеми закупщиками за месяц (в рублях). Рассчитывается на основе `admin_price` из `offer_items`.

### 2.2. Личные показатели (KpiCard)
- **КП ВЫСТАВЛЕНО:** Количество заказов, по которым закупщик подал предложения и которые были утверждены менеджером (статус "КП готово").
- **СУММА КП:** Общая сумма `admin_price` всех товаров в этих утвержденных КП.
- **ВЫИГРАННЫЕ СДЕЛКИ:** Количество уникальных офферов, где хотя бы один товар выбран менеджером как "Лидер".
- **СУММА ВЫИГРЫША:** Сумма `admin_price` только выигравших позиций.

### 2.3. Панель Лидеров (LeaderBoard)
- **Лидеры отдела:** Отображает имена сотрудников с лучшими показателями по количеству и сумме за месяц.
- **Мой прогресс:** Показывает разрыв между текущим пользователем и лидером (в абсолютных числах и процентах).

---

## 3. Тулбар и Навигация (`BuyerToolbar.tsx`)

### 2.1. Поиск
- Поле ввода с иконкой лупы.
- **Логика:** Фильтрация на сервере (`getOrders`). Ищет совпадения по `id` (точный), `vin`, `client_name` или `car_model`.

### 2.2. Умный фильтр Брендов
- **Выпадающий список:**
    - Загружается список брендов, присутствующих в активных заказах (`getSellerBrands`).
    - Поле ввода внутри списка для быстрой фильтрации.
- **Быстрые теги:** Топ-5 брендов выведены в ряд кнопок.
- **Действие:** Клик по бренду -> обновление списка заказов с фильтром `brandFilter`.

### 2.3. Система Табов (Вкладок)
Переключает режим просмотра списка (`activeTab`).

1.  **Новые:** Заказы в обработке, по которым еще нет оффера от текущего закупщика.
2.  **В торгах:** Активные заказы, по которым закупщик уже подал предложение.
3.  **Выигранные:** Заказы, где закупщик выбран лидером хотя бы по одной позиции.
4.  **Проигранные:** Заказы, перешедшие в стадию "КП готово" и выше, где закупщик не стал победителем.
5.  **Архив / Отказ:** Заказы, от которых закупщик отказался (`status='Отказ'`), либо которые были аннулированы менеджером.

---

## 3. Список Заказов (`BuyerOrdersList.tsx`)
Использует виртуализацию (`Virtuoso`) для производительности.

### 3.1. Строка Заказа (`BuyerOrderRow.tsx`)
- **ID заказа:** Отображается в формате `#ID` фиолетовым цветом (`Indigo-600`), жирным шрифтом.
- **Стикеры (Личные метки):**
    - Рядом с ID заказа — иконка тега.
    - Клик открывает палитру цветов. Стикеров видит *только* текущий закупщик.

- **Сортировка:** Доступна по колонкам № заказа, Срок до, Статус, Дата. По умолчанию: **Срок до (ASC)**.

### 3.2. Раскрытие (Детали)
- **Сохранение данных:** Система автоматически восстанавливает ранее введенные закупщиком данные (цены, валюту, вес, сроки) из базы данных. Данные сохраняются при перезагрузке страницы.

---

## 4. Подача Предложения (`BuyerOrderDetails.tsx`)

### 4.1. Таблица позиций
- **Вложения:** В блоке "Вложения" под списком товаров отображаются все документы от оператора и закупщика. Ссылки открываются в новой вкладке.
- **Отказ от позиции:** При нажатии на иконку "Ban" вся строка позиции становится красной и зачеркивается, а поверх полей ввода накладывается блокирующий оверлей с кнопкой "Нажмите, чтобы вернуться в работу".
- **Инструменты конкуренции (Лучшая цена/срок):**
    - Если другие закупщики уже подали предложения, в темной плашке ввода появляются подсказки:
        - `BEST: [Цена]` (зеленая) — самая низкая цена конкурентов.
        - `BEST: [Срок]` (синяя) — самый быстрый срок конкурентов.
- **Поля ввода (в темной плашке):**
    - **Цена закупки (¥):** Число.
    - **Кол-во:** Количество, которое закупщик готов поставить (по умолчанию совпадает с запросом).
    - **Вес (кг):** Вес позиции.
    - **Срок (нед):** Срок поставки. **Минимум 4 недели**.
    - **Ваши файлы (Dropzone):** Область для загрузки документов к конкретной позиции.
- **Дополнительные поля (под плашкой):**
    - **Комментарий / Замена / Аналог:** Текстовое поле.
    - **Название и номер поставщика:** Внутренний идентификатор источника.
- **Копирование:** Кнопка копирования доступна в темной плашке каждой позиции.

### 4.2. Блок Вложений
- **Файлы от оператора:** Список ссылок на документы, приложенные к заказу.
- **От закупщика:** Объединенный список общих файлов оффера и файлов к конкретным позициям (помечены №).
- **Удаление:** Любой загруженный закупщиком файл можно удалить, нажав на крестик в этом блоке (доступно до отправки).
- **Общая дропзона:** Находится над списком файлов, позволяет прикрепить общие документы к заказу.

### 4.3. Кнопка "Отправить предложение"
- **Валидация:** Кнопка неактивна, пока не заполнены все обязательные поля (Цена, Вес, Срок, Название поставщика — если включено в настройках).
- **Кнопка "Отказаться":** (Красная, рядом с кнопкой чата)
  - Позволяет закупщику явно отказаться от заказа (вызывает модальное окно подтверждения).
  - Статус оффера меняется на `Отказ`.
  - Заказ перемещается в таб **"Архив / Отказ"**.

---

## 5. Коммуникация и Уведомления

### 5.1. Чат с Оператором (`BuyerGlobalChat.tsx`)
- **Real-time:** Список чатов и сообщения обновляются мгновенно.
- **Авто-Архивация:** Диалог автоматически перемещается в архив, если с момента **последнего сообщения** прошло 7 дней ИЛИ статус заказа перешел в стадию "КП готово".
- **Восстановление:** При отправке сообщения в архивный чат он возвращается в активные.
- **Удаление:** Кнопка корзины позволяет мгновенно удалить историю чата.
- **Поиск:** Реализована фильтрация списка чатов по номеру заказа.

### 5.2. Всплывающие уведомления (Toasts)
- Появляются в правом верхнем углу экрана.
- Длительность отображения: **1 секунда**.
- Текст "Поставщик" заменен на "Закупщик".
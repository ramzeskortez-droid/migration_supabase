# Глубокое описание Взаимодействия и Логики (System Logic & Interaction)

Этот документ представляет собой исчерпывающее техническое описание бизнес-процессов, алгоритмов и потоков данных платформы. Предназначен для разработчиков и системных архитекторов.

---

## 1. Регистрация и Доступ (Auth & Security)

Система использует кастомную модель аутентификации на основе токенов и одноразовых приглашений.

### 1.1. Генерация Инвайтов
1. **Менеджер** выбирает роль (`operator` или `buyer`) и генерирует уникальный 6-значный код.
2. Код записывается в таблицу `invite_codes` с флагом `is_used = false`.

### 1.2. Процесс Регистрации
1. Пользователь вводит инвайт-код, свое имя и придумывает личный токен.
2. Вызывается RPC-функция `use_invite_code`:
   - Проверяет существование и роль инвайта.
   - Атомарно помечает инвайт как использованный (`is_used = true`).
3. Создается запись в `app_users` со статусом `pending`.
4. **Менеджер** должен вручную одобрить пользователя в разделе "Пользователи", прежде чем тот сможет войти.

---

## 2. Жизненный Цикл Заказа (Order Workflow)

### ЭТАП 1: Инициализация (Ввод данных)
**Роль:** Оператор.

#### 1.1. Обработка Почты (Email Processing)
- **Идентификация:** Каждому письму присваивается порядковый номер `serial_id` (человекочитаемый #1, #2...), который отображается в виджете.
- **Просмотр:** Оператор может кликнуть на карточку письма для открытия полноэкранного попапа с текстом письма (с сохранением форматирования и XSS-очисткой).
- **Блокировка (Locking):** При выборе письма оно блокируется за оператором на **60 секунд**. Другие видят оверлей "Взято в работу". Если заказ не создан за это время, блокировка снимается автоматически.
- **Связывание (Linking)::** При нажатии "В Ассистент" ID письма сохраняется в контексте. При создании заказа этот ID записывается в поле `email_message_id`.
- **Архивация:** Письмо перемещается в статус `processed` (Архив) **только** после успешного создания связанного заказа.

#### 1.2. Создание Заявки
// ... (existing)

#### 1.3. Назначение Закупщиков (Assigned Buyers)
- **По умолчанию:** Заявка видна всем закупщикам (Public).
- **Приватный режим:** Оператор может выбрать конкретных закупщиков из списка при создании заявки.
- **Видимость:**
    - Если закупщики выбраны, заявка видна **только** им (и Менеджеру).
    - Остальные закупщики не видят этот заказ в списке "В обработке".
    - Если закупщик уже сделал оффер по заявке, она остается ему доступна (в истории/торгах) даже при изменении списка доступа.

### ЭТАП 2: Торги (Sourcing)
**Роль:** Закупщик.

#### 2.1. Подача и Редактирование
1. **Расчет сроков поставки:**
   - Закупщик вводит свой "чистый" срок (минимум 1 неделя).
   - При отправке система **автоматически добавляет** к этому сроку значение настройки `delivery_weeks_add` (устанавливается Менеджером).
   - Результат записывается в поле `client_delivery_weeks` таблицы `offer_items` и **фиксируется**. Это значение показывается Менеджеру и Клиенту.
   - Изменение глобальной настройки в будущем **не влияет** на уже созданные офферы.
2. **Редактирование:**
   - Закупщик может редактировать свои предложения в течение таймаута (по умолчанию 5 мин) после отправки, если до дедлайна осталось более 2 минут.
   - В этот момент включается блокировка `locked_at`, чтобы Менеджер не мог случайно утвердить редактируемый заказ.
4. **Авто-отказ:** При попытке отказаться от последней доступной позиции в заказе через интерфейс карточки товара, система перенаправляет действие на кнопку глобального отказа от всего заказа.

### ЭТАП 3: Квалификация и Расценка (Pricing)
**Роль:** Менеджер.
1. **Агрегация файлов:** Менеджер видит в шапке заказа объединенный список всех документов от всех участников.
2. **Разрешение конфликтов:** Если Менеджер пытается утвердить заказ, который сейчас редактируется закупщиком, система выдает предупреждение. При "Force Approve" изменения закупщика сгорают.

---

## 4. Система Чата (P2P Architecture)

### Архитектура
Система использует строгую **Peer-to-Peer (P2P)** модель общения. Каждый чат — это приватная ветка между двумя конкретными пользователями (`sender_id` <-> `recipient_id`) в рамках конкретного заказа (`order_id`).

### Основные принципы
1.  **Приватность:**
    *   Сообщения не группируются в "общие котлы" (как было раньше: "Все Операторы", "Все Менеджеры").
    *   Если Менеджер А пишет Оператору Б — это видит только Менеджер А и Оператор Б.
    *   Другие менеджеры не видят эту переписку.

2.  **Идентификация:**
    *   Собеседники идентифицируются строго по UUID (`sender_id`, `recipient_id`).
    *   Имена и Роли для отображения в UI подтягиваются динамически из таблицы `app_users`.

3.  **Real-time:**
    *   Уведомления приходят через Supabase Realtime только адресату (проверка по `recipient_id` на клиенте).
    *   Счетчики непрочитанных сообщений обновляются мгновенно.

### Видимость чатов
*   **Закупщик:** Видит отдельные ветки с каждым сотрудником (Менеджером или Оператором), который ему написал.
*   **Менеджер:** Видит отдельные ветки с каждым Закупщиком и каждым Оператором.
*   **Оператор:** Видит отдельные ветки с каждым Менеджером и каждым Закупщиком.

### Техническая реализация
*   **Таблица:** `chat_messages` (поля `sender_id`, `recipient_id`, `order_id` обязательны).
*   **API:** Методы `getChatMessages` и `getGlobalChatThreads` используют фильтрацию `OR` для двух сторон диалога.
*   **Legacy:** Старые сообщения (без ID) могут отображаться некорректно или требовать миграции, но новый функционал работает строго через UUID.


---

## 4. Системные Настройки (Global Config)

- **offer_edit_timeout:** Время (в мин) на сессию редактирования оффера.
- **buyer_required_fields:** Настройка обязательности полей.
- **delivery_weeks_add:** Количество недель, добавляемых к сроку закупщика для расчета клиентского срока.
- **debug_mode:** Включает расширенные инструменты отладки.

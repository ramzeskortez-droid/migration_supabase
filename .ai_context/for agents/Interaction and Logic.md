# Глубокое описание Взаимодействия и Логики (System Logic & Interaction)

Этот документ представляет собой исчерпывающее техническое описание бизнес-процессов, алгоритмов и потоков данных платформы. Предназначен для разработчиков и системных архитекторов.

---

## 1. Регистрация и Доступ (Auth & Security)

Система использует кастомную модель аутентификации на основе токенов и одноразовых приглашений.

### 1.1. Генерация Инвайтов
1. **Менеджер** выбирает роль (`operator` или `buyer`) и генерирует уникальный 6-значный код.
2. Код записывается в таблицу `invite_codes` с флагом `is_used = false`.

### 1.2. Процесс Регистрации
1. Пользователь вводит инвайт-код, свое имя и придумывает личный токен.
2. Вызывается RPC-функция `use_invite_code`:
   - Проверяет существование и роль инвайта.
   - Атомарно помечает инвайт как использованный (`is_used = true`).
3. Создается запись в `app_users` со статусом `pending`.
4. **Менеджер** должен вручную одобрить пользователя в разделе "Пользователи", прежде чем тот сможет войти.

---

## 2. Жизненный Цикл Заказа (Order Workflow)

### ЭТАП 1: Инициализация (Ввод данных)
**Роль:** Оператор.
1. **Загрузка файлов:** 
   - **Общие файлы:** Прикрепляются к шапке заказа (`order_files`).
   - **Файлы позиций:** Прикрепляются к конкретной строке товара (`item_files`).
   - *Logic:* Если AI-ассистент определил фото товара, но оператор не добавил других файлов, фото автоматически конвертируется в массив `item_files` для унификации хранения.
2. **Создание:** При сохранении заказа `owner_id` привязывается к UUID текущего оператора для изоляции данных (RLS).

### ЭТАП 2: Торги (Sourcing)
**Роль:** Закупщик.
1. **Позиционные файлы:** Закупщик может прикрепить документы к каждой строке товара (`item_files`).
2. **Общие файлы:** Закупщик может добавить общие документы к офферу (`supplier_files`).
3. **Валидация:** Если менеджер включил обязательность поля `supplier_sku` в настройках, закупщик не сможет отправить оффер без его заполнения.

### ЭТАП 3: Квалификация и Расценка (Pricing)
**Роль:** Менеджер.
1. **Агрегация файлов:** Менеджер видит в шапке заказа объединенный список всех документов: от оператора и от всех закупщиков (с пометками авторства).
2. **Авто-расчет Срока:** Система берет срок закупщика (нед.) и автоматически прибавляет к нему значение из настроек (по умолчанию **+4 недели**).

---

## 3. Коммуникация (Chat Engine)

### 3.1. Ролевая модель чата
Сообщения сохраняются с четким указанием роли отправителя для визуального разделения:
- **MANAGER** (ex-Admin) — Зеленый блок.
- **OPERATOR** — Синий блок.
- **SUPPLIER** — Желтый блок.

### 3.2. Контекстная навигация
Менеджер может инициировать чат прямо из карточки заказа:
- Кнопка "Чат с оператором" в футере.
- Иконка чата рядом с именем поставщика.
При переходе `GlobalChatWindow` автоматически открывает нужный диалог.

---

## 4. Системные Настройки (Global Config)

Менеджер управляет поведением системы через таблицу `system_settings`:
- **buyer_required_fields:** JSON-объект, определяющий обязательность полей (напр. `supplier_sku`).
- **exchange_rates:** Включает не только курсы, но и `delivery_weeks_add` (добавка к сроку клиента).
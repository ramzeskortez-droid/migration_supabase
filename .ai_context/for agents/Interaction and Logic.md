# Взаимодействие и Логика Системы

Этот документ описывает потоки данных (Data Flow) и бизнес-логику переходов между статусами.

## 1. Жизненный цикл Заказа (Workflow)

### Этап 1: Создание (Оператор)
1.  **Ввод:** Оператор вводит текст или использует AI-парсинг.
2.  **Валидация:** Система проверяет наличие брендов в справочнике `brands`. Если бренд неизвестен, создание блокируется.
3.  **Создание:** Запись в таблицу `orders` и `order_items`.
    *   Статус Админ: `В обработке`
    *   Статус Клиент: `В обработке`
    *   `owner_token`: Токен оператора.

### Этап 2: Сбор предложений (Закупщик)
1.  **Видимость:** Заказ появляется в табе "Новые" у всех закупщиков (кроме тех, кто уже ответил).
2.  **Оффер:** Закупщик заполняет цены, сроки, веса.
3.  **Действие:** Нажатие "Отправить".
    *   Создается запись в `offers`.
    *   Заказ исчезает из "Новых" -> переходит в "Отправленные".
    *   Статус поставщика обновляется на `Идут торги`.

### Этап 3: Отбор и Расценка (Менеджер)
1.  **Уведомление:** Менеджер видит `+1` в колонке "Офферы" (обновление раз в 5 сек).
2.  **Анализ:** Менеджер открывает заказ. Система автоматически рассчитывает цену для клиента в рублях, используя курсы из `exchange_rates`.
    *   *Формула:* `(Цена_Поставщика * Курс_Валюты) + (Вес * Тариф_Доставки * Курс_USD) + Наценка`.
3.  **Выбор:** Менеджер нажимает "ВЫБРАТЬ" напротив лучшего оффера.
    *   В БД: `offer_items.is_winner = true`.
    *   Синхронизация: Рассчитанная цена копируется в `order_items.admin_price_rub`.
4.  **Утверждение:** Когда лидеры выбраны, менеджер жмет "Утвердить КП".
    *   Статус Админ: `КП готово` (или `КП отправлено`).

### Этап 4: Финализация (Оператор)
1.  **Проверка:** Оператор видит в своем списке статус `КП готово` или видит цены в деталях заказа.
2.  **Действие:** Оператор сообщает цену клиенту.
3.  **Закрытие:** Оператор нажимает кнопку "Обработано".
    *   Статус переходит в финальную стадию согласования.

---

## 2. Ключевые Механики

### 2.1. Изоляция Данных (Security)
*   **Операторы:** Видят только заказы, где `owner_token` совпадает с их токеном.
*   **Закупщики:** Видят все активные заказы, но в деталях видят только *свои* офферы (через фильтрацию на клиенте/сервере).
*   **Менеджеры:** Видят абсолютно всё (Superuser).

### 2.2. Финансовая Логика
*   **Источники данных:** Таблица `exchange_rates`.
*   **Приоритет:**
    1.  Ручной ввод (флаг `is_manual_price`).
    2.  Авторасчет (если ручного нет).
*   **Валюты:** Поддержка CNY, USD, RUB. Конвертация всегда приводится к RUB для клиента.

### 2.3. Система Коммуникации (Чат)
*   **Архитектура:** Единая таблица `chat_messages`.
*   **Роли:**
    *   `SENDER`: 'ADMIN' (Менеджер/Оператор) или 'SUPPLIER'.
*   **Маршрутизация:**
    *   Закупщик пишет -> Видят все операторы (в общем окне) и Менеджер.
    *   Оператор отвечает -> Закупщик видит ответ с именем "Оператор - [Имя]".
*   **Контекст:** Чат всегда привязан к `order_id`.

### 2.4. Валидация Регистрации (Закупщик)
*   **Инвайт-код:** `china-nai` (хардкод).
*   **Телефон:** Строго 11 цифр (очистка от масок).
*   **Дубликаты:** Проверка уникальности токена в БД.

---

## 3. Таблица Статусов

| Статус (DB) | Отображение (UI) | Кто ставит | Когда |
| :--- | :--- | :--- | :--- |
| `В обработке` | В обработке | Оператор | При создании |
| `Идут торги` | Идут торги | Система | При первом оффере |
| `КП готово` | КП готово | Менеджер | После утверждения КП |
| `КП отправлено` | КП отправлено | Менеджер/Оператор | После отправки клиенту |
| `Готов купить` | Готов купить | Менеджер | Клиент согласен |
| `Подтверждение...` | Подтверждение | Менеджер | Закуп подтвержден |
| `Аннулирован` | Аннулирован | Менеджер | Отмена заказа |

# Глубокое описание Взаимодействия и Логики (System Logic & Interaction)

Этот документ представляет собой исчерпывающее техническое описание бизнес-процессов, алгоритмов и потоков данных платформы. Предназначен для разработчиков и системных архитекторов.

---

## 1. Регистрация и Доступ (Auth & Security)

Система использует кастомную модель аутентификации на основе токенов и одноразовых приглашений.

### 1.1. Генерация Инвайтов
1. **Менеджер** выбирает роль (`operator` или `buyer`) и генерирует уникальный 6-значный код.
2. Код записывается в таблицу `invite_codes` с флагом `is_used = false`.

### 1.2. Процесс Регистрации
1. Пользователь вводит инвайт-код, свое имя и придумывает личный токен.
2. Вызывается RPC-функция `use_invite_code`:
   - Проверяет существование и роль инвайта.
   - Атомарно помечает инвайт как использованный (`is_used = true`).
3. Создается запись в `app_users` со статусом `pending`.
4. **Менеджер** должен вручную одобрить пользователя в разделе "Пользователи", прежде чем тот сможет войти.

---

## 2. Жизненный Цикл Заказа (Order Workflow)

### ЭТАП 1: Инициализация (Ввод данных)
**Роль:** Оператор.

#### 1.1. Обработка Почты (Email Processing)
- **Блокировка (Locking):** При выборе письма оно блокируется за оператором на **60 секунд**. Другие видят оверлей "Взято в работу". Если заказ не создан за это время, блокировка снимается автоматически.
- **Связывание (Linking):** При нажатии "В Ассистент" ID письма сохраняется в контексте. При создании заказа этот ID записывается в поле `email_message_id`.
- **Архивация:** Письмо перемещается в статус `processed` (Архив) **только** после успешного создания связанного заказа.

#### 1.2. Создание Заявки
1. **Загрузка файлов:** 
   - **Глобальный Drag-n-Drop:** Оператор может перетащить файл в любое место формы создания. При наведении появляется пунктирная рамка и блюр.
   - **Позиционные файлы:** Файлы, сброшенные на конкретную строку позиции, прикрепляются именно к этой строке.
2. **Создание:** При сохранении заказа `owner_id` привязывается к UUID текущего оператора для изоляции данных (RLS).

### ЭТАП 2: Торги (Sourcing)
**Роль:** Закупщик.

#### 2.1. Подача и Редактирование
1. **Валидация:** Поля (Вес, Срок и т.д.) становятся обязательными только после ввода цены для конкретной позиции.
2. **Редактирование (Amend):** Закупщик может изменить отправленный оффер, пока Менеджер не утвердил КП.
   - Кнопка **"Изменить / Дополнить"** переводит карточку в режим формы.
   - В БД устанавливается `locked_at` (начало сессии редактирования).
   - Если до авто-закрытия заказа (3 дня) осталось менее `Timeout + 2 мин`, редактирование блокируется.
3. **Блокировка Менеджера:** Пока закупщик редактирует, Менеджер видит оверлей "Закупщик вносит изменения".

### ЭТАП 3: Квалификация и Расценка (Pricing)
**Роль:** Менеджер.
1. **Агрегация файлов:** Менеджер видит в шапке заказа объединенный список всех документов от всех участников.
2. **Разрешение конфликтов:** Если Менеджер пытается утвердить заказ, который сейчас редактируется закупщиком, система выдает предупреждение. При "Force Approve" изменения закупщика сгорают.

---

## 3. Коммуникация (Chat Engine)

### 3.1. Ролевая модель чата
- **MANAGER** (Зеленый), **OPERATOR** (Синий), **SUPPLIER** (Желтый).

---

## 4. Системные Настройки (Global Config)

- **offer_edit_timeout:** Время (в мин) на сессию редактирования оффера.
- **buyer_required_fields:** Настройка обязательности полей.
- **debug_mode:** Включает расширенные инструменты отладки.
# Глобальные правила (System Rules)

**Эти правила являются обязательными к исполнению во всех задачах.**

1. **Язык и Стиль:**
   - Русский язык для всех ответов, комментариев и документации.
   - Стиль общения: Профессиональный, лаконичный.

2. **Безопасность кода:**
   - Не вносить изменений вне контекста текущей задачи.
   - О критических архитектурных изменениях предупреждать заранее.

3. **Технологический стек (Strict):**
   - **Backend:** Supabase (PostgreSQL). Прямое взаимодействие через `supabaseClient.ts`.
   - **State:** React Query v5. Обязательное использование `invalidateQueries` после мутаций.
   - **UI:** Tailwind CSS. Строгое соблюдение текущей цветовой схемы и сетки.

4. **Работа с документацией (КРИТИЧНО):**
   - Папка `for agents` — **основной источник знаний**.
   - **ОБЯЗАННОСТЬ:** При изменении UI (добавление кнопок, полей, изменение верстки или поведения элементов) ты ОБЯЗАН обновить соответствующий файл:
     - `Operator Interface.md`
     - `Buyer Interface.md`
     - `Manager Interface.md`
   - При изменении бизнес-логики или потоков данных обновляй `Interaction and Logic.md`.
   - При появлении новых терминов обновляй `Technical Terms.md`.

5. **Терминология и Роли:**
   - **Менеджер (Manager):** Управление ценами и воронкой.
   - **Закупщик (Buyer):** Подача ценовых предложений (офферов).
   - **Оператор (Operator):** Ввод и первичная обработка заявок.
   - **Order:** Заявка клиента.
   - **Offer:** Предложение от закупщика.

6. **Принципы разработки:**
   - **Изоляция:** Строгая проверка `owner_token` для Оператора.
   - **Валидация:** Проверка брендов по справочнику, санитарная очистка вводимых данных (особенно цен и телефонов).
   - **Real-time:** Обеспечение актуальности данных (через polling или подписки Supabase).

7. **Работа с багами (bugs_log.md):**
   - Ты **ОБЯЗАН** вести файл `.ai_context/for agents/bugs_log.md`.
   - **КОНЦЕПЦИЯ:** Этот файл — **база знаний для предотвращения рецидивов**. В разных сессиях (без общего контекста) мы часто сталкиваемся с похожими проблемами. Цель файла — помочь агенту в будущих сессиях быстро понять природу ошибки и применить уже найденное решение, сэкономив токены и время.
   - **КОГДА:** После каждого успешного решения сложной, неочевидной или повторяющейся проблемы.
   - **ПРОЦЕСС:** Спроси пользователя: "Могу ли я занести эту проблему и решение в лог багов?".
   - **ТРЕБОВАНИЕ К ДЕТАЛИЗАЦИИ:** 
     - **Проблема:** Описывай симптомы так, чтобы агент в новой сессии мог узнать их (цитаты пользователя, коды ошибок, поведение UI).
     - **Решение:** Описывай техническую суть так, чтобы агент мог сразу применить фикс (конкретные файлы, методы, логика).
   - **ФОРМАТ ЗАПИСИ:**
     ```markdown
     ## [Дата] - [Краткое название проблемы]
     **Версия:** [Текущая версия]
     **Проблема:** [Симптомы, цитаты, ошибки в консоли]
     **Причина:** [Технический корень проблемы]
     **Решение:** [Алгоритм исправления]
     **Статус:** Исправлено
     ```

8. **Отчетность и GIT (КРИТИЧНО):**
   - **GIT COMMIT & PUSH:** **КАТЕГОРИЧЕСКИ ЗАПРЕЩЕНО** делать `git commit` или `git push` без прямой команды пользователя.
   - Выполняй работу, проверяй её, и только после слов "Сделай комит" или "Отправь" приступай к фиксации.
   - По завершении: краткий список "Что сделано" и блок "Как проверить".
   - Сообщения коммитов (Git) — **только на русском языке**.
   - **ЗАПРЕЩЕНЫ** комиты состоящие только из заголовка. Описание обязательно.
   - **Обязательная структура коммита:**
     1. **Заголовок:** `ВЕРСИЯ [X.X.X] - [Краткое название]`
     2. **Описание:** Детальный перечень изменений (списком).
     3. **Блок "БЫЛА ПРОБЛЕМА":** Четкое описание бага или отсутствующей функции, которую мы решали.
     4. **Блок "КАК РЕШИЛИ":** Техническое описание реализации.
   - *Техническое примечание:* Если консоль не принимает многострочный текст, используй передачу сообщения через файл (`git commit -F msg.txt`). Несоответствие формата считается нарушением правил.

9. **Превентивный Рефакторинг и Именование (НОВОЕ):**
   - **Правило:** Если при выполнении задачи ты открываешь файл, который явно перегружен (более 300 строк, смешанная ответственность, "God object") — **ПРЕДЛОЖИ** пользователю сначала провести декомпозицию, прежде чем вносить изменения. Не копи техдолг.
   - **Именование:** Все *новые* React-компоненты (кроме ui-kit) ОБЯЗАНЫ именоваться по маске: `EnglishName(RussianDescription).tsx`.
     - *Пример:* `OperatorOrderRow.tsx` -> `OperatorClientInfo(ИнформацияОКлиенте).tsx`.
     - Это помогает русскоязычной команде быстрее ориентироваться в структуре проекта.

10. **Анализ перекрестного влияния (Cross-Impact Analysis):**
   - **ОБЯЗАТЕЛЬНО:** Перед началом любых изменений кода или схемы БД ты обязан проанализировать, как это отразится на других ролях (Оператор / Закупщик / Менеджер).
   - **КОНТЕКСТ:** Система тесно связана. Изменение статуса для Оператора может сломать воронку Менеджера или скрыть заказ от Закупщика.
   - **ДЕЙСТВИЕ:** На этапе "Understand" (чтение файлов) явно напиши пользователю: *"Внимание: Это изменение затронет также интерфейс [Роль], так как [Причина]. Нужно ли учесть [Деталь]?"* или *"Анализ: Изменение локально и безопасно для других ролей."*
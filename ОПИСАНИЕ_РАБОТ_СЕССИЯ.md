# Отчет о переносе функций и настройке почты (Сессия от 15.01.2026)

## 1. Цель работ
Перенос логики Edge Functions (обработка писем через AI, синхронизация почты, интеграция с Bitrix24) из облачного Supabase на собственный VPS-сервер (self-hosted Supabase в Docker).

## 2. Что было сделано

### Настройка инфраструктуры Supabase
- **Локализация папок:** Определено рабочее окружение Docker в `/root/supabase-docker/docker` на сервере.
- **Развертывание функций:** Файлы функций перенесены в системную папку `volumes/functions`, которую "видит" рантайм Supabase.
- **Исправление прав доступа:** Все файлы функций переданы пользователю `1000:1000` (стандарт для Deno/Edge Runtime), что решило проблему ошибок доступа (Permission Denied).
- **Оптимизация кода:** Удалены импорты типов (`jsr:`), которые вызывали ошибки сборки (boot error) в изолированной среде Docker.

### Обход блокировок (Нейросеть Groq)
- **Проблема:** Прямые запросы к Groq API с российского IP сервера блокировались (ошибка 403 Forbidden).
- **Решение:** Настроен прокси-сервер (`70.38.2.19:10978`) через файл `docker-compose.override.yml`. 
- **Результат:** Функция `process-email` успешно отправляет запросы через прокси и возвращает разобранные JSON-данные.

### Синхронизация почты (Mail.ru)
- **Проблема:** Функция `fetch-emails` внутри Supabase постоянно зависала и выдавала ошибку "504 Gateway Time-out" или "Wall clock duration reached". Это было связано с сетевыми задержками протокола IMAP и лимитами времени выполнения (60 сек) в Supabase.
- **Решение (Кардинальное):** Создан отдельный фоновый сервис на Node.js вне Docker-контейнера.
- **Скрипт синхронизации:** В папке `/root/mail-sync` на сервере запущен скрипт `index.js`, который работает в режиме **IDLE (Push)**. Он держит постоянное соединение с Mail.ru и моментально сохраняет письма в базу данных.
- **Результат:** Все непрочитанные письма теперь загружаются в таблицу `incoming_emails` автоматически и мгновенно.

## 3. Где и что теперь работает (на сервере)

| Компонент | Расположение | Статус |
| :--- | :--- | :--- |
| **Supabase (База, API, UI)** | `~/supabase-docker/docker` | Работает (порт 8000) |
| **Нейросеть (AI Analysis)** | Edge Function `process-email` | Работает через прокси |
| **Синхронизация почты** | Скрипт `~/mail-sync/index.js` | Работает в фоне (24/7) |
| **Переменные окружения** | `~/supabase-docker/docker/.env` | Настроены (Ключи, Прокси) |

## 4. Как управлять системой на сервере

### Проверка почтового скрипта:
```bash
ps aux | grep index.js  # Проверить, запущен ли процесс
tail -f /root/mail-sync/mail.log  # Посмотреть живые логи почты
```

### Перезапуск нейросети (если изменили код):
```bash
cd /root/supabase-docker/docker
docker compose restart functions
```

### Если сервер перезагрузится:
Нужно заново запустить почтовый скрипт:
```bash
cd /root/mail-sync && nohup node index.js > mail.log 2>&1 &
```

## 5. Достигнутые результаты
- Система полностью перенесена на VPS.
- Обойдены географические блокировки API.
- Настроена мгновенная (Push) доставка писем в базу данных.
- Все функции протестированы и выдают корректные результаты.

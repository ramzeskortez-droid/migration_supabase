[
  {
    "function_name": "get_seller_feed",
    "definition": "CREATE OR REPLACE FUNCTION public.get_seller_feed(p_seller_name text, p_tab text, p_page integer, p_limit integer, p_search text DEFAULT ''::text)\n RETURNS TABLE(id bigint, created_at timestamp with time zone, client_name text, car_brand text, car_model text, car_year text, vin text, status_admin text, status_client text, status_supplier text, visible_to_client boolean, offers_count bigint, items jsonb, my_offer jsonb, total_count bigint)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_offset INTEGER := (p_page - 1) * p_limit;\r\n    v_search_pattern TEXT := '%' || p_search || '%';\r\nBEGIN\r\n    RETURN QUERY\r\n    WITH filtered_orders AS (\r\n        SELECT \r\n            o.*,\r\n            (SELECT COUNT(*) FROM public.offers off WHERE off.order_id = o.id) as o_count,\r\n            EXISTS (\r\n                SELECT 1 FROM public.offers off \r\n                WHERE off.order_id = o.id \r\n                AND off.supplier_name ILIKE p_seller_name\r\n            ) as has_my_offer\r\n        FROM public.orders o\r\n        WHERE \r\n            -- Поиск\r\n            (p_search = '' OR (\r\n                o.vin ILIKE v_search_pattern OR\r\n                o.id::TEXT ILIKE v_search_pattern OR\r\n                o.car_model ILIKE v_search_pattern OR\r\n                o.car_brand ILIKE v_search_pattern\r\n            ))\r\n            AND\r\n            -- Фильтрация по табам\r\n            CASE \r\n                WHEN p_tab = 'new' THEN\r\n                    -- Новые: Видны клиенту (или в обработке), активны, нет моего оффера\r\n                    (o.status_admin = 'В обработке' OR o.status_admin = 'ОТКРЫТ')\r\n                    AND NOT (\r\n                        EXISTS (\r\n                            SELECT 1 FROM public.offers off \r\n                            WHERE off.order_id = o.id \r\n                            AND off.supplier_name ILIKE p_seller_name\r\n                        )\r\n                    )\r\n                    AND o.status_admin != 'ЗАКРЫТ' \r\n                    AND o.status_admin != 'Аннулирован'\r\n                    AND o.status_admin != 'Отказ'\r\n                WHEN p_tab = 'history' THEN\r\n                    -- История: Есть мой оффер\r\n                    EXISTS (\r\n                        SELECT 1 FROM public.offers off \r\n                        WHERE off.order_id = o.id \r\n                        AND off.supplier_name ILIKE p_seller_name\r\n                    )\r\n                ELSE FALSE\r\n            END\r\n    ),\r\n    total_cnt AS (\r\n        SELECT COUNT(*) as cnt FROM filtered_orders\r\n    )\r\n    SELECT \r\n        fo.id,\r\n        fo.created_at,\r\n        fo.client_name,\r\n        fo.car_brand,\r\n        fo.car_model,\r\n        fo.car_year,\r\n        fo.vin,\r\n        fo.status_admin,\r\n        fo.status_client,\r\n        fo.status_supplier,\r\n        fo.visible_to_client,\r\n        fo.o_count,\r\n        (\r\n            SELECT jsonb_agg(\r\n                jsonb_build_object(\r\n                    'id', oi.id,\r\n                    'name', oi.name,\r\n                    'quantity', oi.quantity,\r\n                    'category', oi.category,\r\n                    'comment', oi.comment\r\n                )\r\n            )\r\n            FROM public.order_items oi\r\n            WHERE oi.order_id = fo.id\r\n        ) as items,\r\n        (\r\n            SELECT row_to_json(off)::jsonb\r\n            FROM (\r\n                SELECT \r\n                    off.id, \r\n                    off.supplier_name, \r\n                    (\r\n                        SELECT jsonb_agg(\r\n                            jsonb_build_object(\r\n                                'id', ofi.id,\r\n                                'name', ofi.name,\r\n                                'quantity', ofi.quantity,\r\n                                'sellerPrice', ofi.price,\r\n                                'weight', ofi.weight,\r\n                                'deliveryWeeks', ofi.delivery_days / 7, -- Примерная конвертация обратно\r\n                                'photoUrl', ofi.photo_url,\r\n                                'offeredQuantity', ofi.quantity,\r\n                                'rank', CASE WHEN ofi.is_winner THEN 'ЛИДЕР' ELSE '' END,\r\n                                'adminComment', ofi.admin_comment\r\n                            )\r\n                        )\r\n                        FROM public.offer_items ofi\r\n                        WHERE ofi.offer_id = off.id\r\n                    ) as items\r\n                FROM public.offers off\r\n                WHERE off.order_id = fo.id AND off.supplier_name ILIKE p_seller_name\r\n                LIMIT 1\r\n            ) off\r\n        ) as my_offer,\r\n        tc.cnt\r\n    FROM filtered_orders fo, total_cnt tc\r\n    ORDER BY fo.created_at DESC\r\n    LIMIT p_limit\r\n    OFFSET v_offset;\r\nEND;\r\n$function$\n"
  },
  {
    "function_name": "offers_count",
    "definition": "CREATE OR REPLACE FUNCTION public.offers_count(orders_row orders)\n RETURNS bigint\n LANGUAGE sql\n STABLE\nAS $function$\r\n  SELECT COUNT(*) FROM offers WHERE order_id = orders_row.id;\r\n$function$\n"
  },
  {
    "function_name": "approve_order_winners",
    "definition": "CREATE OR REPLACE FUNCTION public.approve_order_winners(p_order_id bigint, p_winners jsonb)\n RETURNS void\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    w_item JSONB;\r\n    w_id BIGINT;\r\n    w_price NUMERIC;\r\n    w_currency TEXT;\r\n    w_delivery NUMERIC;\r\n    w_comment TEXT;\r\n    w_item_name TEXT;\r\nBEGIN\r\n    -- А. Обновляем статус заказа и ВРЕМЯ ОБНОВЛЕНИЯ\r\n    UPDATE public.orders\r\n    SET \r\n        status_client = 'КП отправлено',\r\n        status_admin = 'КП готово',\r\n        status_updated_at = timezone('utc'::text, now()) -- <--- ВАЖНО: Обновляем время\r\n    WHERE id = p_order_id;\r\n\r\n    -- Б. Обрабатываем победителей\r\n    FOR w_item IN SELECT * FROM jsonb_array_elements(p_winners)\r\n    LOOP\r\n        w_id := (w_item->>'id')::BIGINT;\r\n        w_price := (w_item->>'admin_price')::NUMERIC;\r\n        w_currency := (w_item->>'admin_currency')::TEXT;\r\n        w_delivery := (w_item->>'delivery_rate')::NUMERIC;\r\n        w_comment := (w_item->>'admin_comment')::TEXT;\r\n\r\n        SELECT name INTO w_item_name FROM public.offer_items WHERE id = w_id;\r\n\r\n        UPDATE public.offer_items oi\r\n        SET is_winner = FALSE\r\n        FROM public.offers o\r\n        WHERE oi.offer_id = o.id\r\n          AND o.order_id = p_order_id\r\n          AND oi.name = w_item_name;\r\n\r\n        UPDATE public.offer_items\r\n        SET \r\n            is_winner = TRUE,\r\n            admin_price = w_price,\r\n            admin_currency = w_currency,\r\n            delivery_rate = w_delivery,\r\n            admin_comment = w_comment\r\n        WHERE id = w_id;\r\n        \r\n    END LOOP;\r\nEND;\r\n$function$\n"
  },
  {
    "function_name": "get_seller_feed",
    "definition": "CREATE OR REPLACE FUNCTION public.get_seller_feed(p_seller_name text, p_tab text, p_page integer, p_limit integer, p_search text DEFAULT ''::text, p_sort_col text DEFAULT 'created_at'::text, p_sort_dir text DEFAULT 'desc'::text)\n RETURNS TABLE(id bigint, created_at timestamp with time zone, client_name text, car_brand text, car_model text, car_year text, vin text, status_admin text, status_client text, status_supplier text, visible_to_client boolean, offers_count bigint, items jsonb, my_offer jsonb, total_count bigint, count_new bigint, count_history bigint)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_offset INTEGER := (p_page - 1) * p_limit;\r\n    v_search_safe TEXT := COALESCE(p_search, '');\r\n    v_search_pattern TEXT := '%' || v_search_safe || '%';\r\n    v_sql TEXT;\r\n    v_sort_clause TEXT;\r\nBEGIN\r\n    IF p_sort_col = 'id' THEN v_sort_clause := 'ct.id';\r\n    ELSIF p_sort_col = 'brand' THEN v_sort_clause := 'ct.car_brand';\r\n    ELSIF p_sort_col = 'model' THEN v_sort_clause := 'ct.car_model';\r\n    ELSE v_sort_clause := 'ct.created_at'; END IF;\r\n\r\n    IF p_sort_dir = 'asc' THEN v_sort_clause := v_sort_clause || ' ASC';\r\n    ELSE v_sort_clause := v_sort_clause || ' DESC'; END IF;\r\n\r\n    v_sql := '\r\n    WITH base_orders AS (\r\n        SELECT \r\n            o.*,\r\n            (SELECT COUNT(*) FROM public.offers off WHERE off.order_id = o.id) as o_count,\r\n            (\r\n                SELECT row_to_json(off_data)::jsonb\r\n                FROM (\r\n                    SELECT \r\n                        off.id, \r\n                        off.supplier_name, \r\n                        (\r\n                            SELECT jsonb_agg(\r\n                                jsonb_build_object(\r\n                                    ''id'', ofi.id,\r\n                                    ''name'', ofi.name,\r\n                                    ''quantity'', ofi.quantity,\r\n                                    ''sellerPrice'', ofi.price,\r\n                                    ''weight'', ofi.weight,\r\n                                    ''deliveryWeeks'', ofi.delivery_days / 7,\r\n                                    ''photoUrl'', ofi.photo_url,\r\n                                    ''offeredQuantity'', ofi.quantity,\r\n                                    ''rank'', CASE WHEN ofi.is_winner THEN ''ЛИДЕР'' ELSE '''' END,\r\n                                    ''adminComment'', ofi.admin_comment\r\n                                )\r\n                            )\r\n                            FROM public.offer_items ofi\r\n                            WHERE ofi.offer_id = off.id\r\n                        ) as items\r\n                    FROM public.offers off\r\n                    WHERE off.order_id = o.id AND TRIM(off.supplier_name) ILIKE TRIM($1)\r\n                    LIMIT 1\r\n                ) off_data\r\n            ) as my_off\r\n        FROM public.orders o\r\n        WHERE \r\n            ($2 = '''' OR (\r\n                o.vin ILIKE $3 OR\r\n                o.id::TEXT ILIKE $3 OR\r\n                o.car_model ILIKE $3 OR\r\n                o.car_brand ILIKE $3\r\n            ))\r\n    ),\r\n    tab_new AS (\r\n        SELECT * FROM base_orders \r\n        WHERE my_off IS NULL \r\n          AND status_admin NOT IN (''ЗАКРЫТ'', ''Аннулирован'', ''Отказ'', ''Выполнен'', ''В пути'')\r\n    ),\r\n    tab_history AS (\r\n        SELECT * FROM base_orders WHERE my_off IS NOT NULL\r\n    ),\r\n    counts AS (\r\n        SELECT \r\n            (SELECT COUNT(*) FROM tab_new) as c_new,\r\n            (SELECT COUNT(*) FROM tab_history) as c_history\r\n    )\r\n    SELECT \r\n        ct.id,\r\n        ct.created_at,\r\n        ct.client_name,\r\n        ct.car_brand,\r\n        ct.car_model,\r\n        ct.car_year,\r\n        ct.vin,\r\n        ct.status_admin,\r\n        ct.status_client,\r\n        ct.status_supplier,\r\n        ct.visible_to_client,\r\n        ct.o_count,\r\n        (\r\n            SELECT jsonb_agg(\r\n                jsonb_build_object(\r\n                    ''id'', oi.id,\r\n                    ''name'', oi.name,\r\n                    ''quantity'', oi.quantity,\r\n                    ''category'', oi.category\r\n                )\r\n            )\r\n            FROM public.order_items oi\r\n            WHERE oi.order_id = ct.id\r\n        ) as items,\r\n        ct.my_off,\r\n        (SELECT COUNT(*) FROM (SELECT 1 FROM tab_new WHERE $4 = ''new'' UNION ALL SELECT 1 FROM tab_history WHERE $4 = ''history'') t) as c_total,\r\n        c.c_new,\r\n        c.c_history\r\n    FROM (\r\n        SELECT * FROM tab_new WHERE $4 = ''new''\r\n        UNION ALL\r\n        SELECT * FROM tab_history WHERE $4 = ''history''\r\n    ) ct, counts c\r\n    ORDER BY ' || v_sort_clause || '\r\n    LIMIT $5\r\n    OFFSET $6';\r\n\r\n    RETURN QUERY EXECUTE v_sql \r\n    USING p_seller_name, v_search_safe, v_search_pattern, p_tab, p_limit, v_offset;\r\nEND;\r\n$function$\n"
  },
  {
    "function_name": "total_cost",
    "definition": "CREATE OR REPLACE FUNCTION public.total_cost(item offer_items)\n RETURNS numeric\n LANGUAGE sql\n STABLE\nAS $function$\r\n  SELECT (\r\n    COALESCE(item.admin_price, item.price, 0) * item.quantity \r\n    + \r\n    COALESCE(item.delivery_rate, 0)\r\n  );\r\n$function$\n"
  },
  {
    "function_name": "goods_cost",
    "definition": "CREATE OR REPLACE FUNCTION public.goods_cost(item offer_items)\n RETURNS numeric\n LANGUAGE sql\n STABLE\nAS $function$\r\n  SELECT (\r\n    COALESCE(item.admin_price, item.price, 0) * item.quantity\r\n  );\r\n$function$\n"
  },
  {
    "function_name": "debug_seller_feed",
    "definition": "CREATE OR REPLACE FUNCTION public.debug_seller_feed(p_seller_name text)\n RETURNS TABLE(info text, val text)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_total_orders BIGINT;\r\n    v_open_orders BIGINT;\r\n    v_my_offers_count BIGINT;\r\n    v_sample_status TEXT;\r\n    v_sample_offer_name TEXT;\r\nBEGIN\r\n    -- 1. Всего заказов\r\n    SELECT COUNT(*) INTO v_total_orders FROM public.orders;\r\n    RETURN QUERY SELECT 'Total Orders'::TEXT, v_total_orders::TEXT;\r\n\r\n    -- 2. Открытых заказов (проверка статусов)\r\n    SELECT COUNT(*) INTO v_open_orders FROM public.orders \r\n    WHERE status_admin NOT IN ('ЗАКРЫТ', 'Аннулирован', 'Отказ', 'Выполнен', 'В пути');\r\n    RETURN QUERY SELECT 'Open Orders (Filtered)'::TEXT, v_open_orders::TEXT;\r\n\r\n    -- 3. Пример статуса одного заказа\r\n    SELECT status_admin INTO v_sample_status FROM public.orders LIMIT 1;\r\n    RETURN QUERY SELECT 'Sample Status'::TEXT, v_sample_status::TEXT;\r\n\r\n    -- 4. Сколько офферов с таким именем (проверка ILIKE)\r\n    SELECT COUNT(*) INTO v_my_offers_count FROM public.offers \r\n    WHERE TRIM(supplier_name) ILIKE TRIM(p_seller_name);\r\n    RETURN QUERY SELECT 'Offers Found for Seller'::TEXT, v_my_offers_count::TEXT;\r\n\r\n    -- 5. Пример имени поставщика из базы (первый попавшийся)\r\n    SELECT supplier_name INTO v_sample_offer_name FROM public.offers LIMIT 1;\r\n    RETURN QUERY SELECT 'Sample Offer Name in DB'::TEXT, v_sample_offer_name::TEXT;\r\n    \r\n    -- 6. Что мы искали\r\n    RETURN QUERY SELECT 'Searching For'::TEXT, p_seller_name;\r\nEND;\r\n$function$\n"
  },
  {
    "function_name": "get_seller_brands",
    "definition": "CREATE OR REPLACE FUNCTION public.get_seller_brands(p_seller_name text)\n RETURNS TABLE(brand text)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n    RETURN QUERY\r\n    SELECT DISTINCT car_brand\r\n    FROM public.orders o\r\n    WHERE \r\n       -- Условия как для таба 'new' (то, что можно взять в работу)\r\n       status_admin NOT IN ('ЗАКРЫТ', 'Аннулирован', 'Отказ', 'Выполнен', 'В пути')\r\n       AND NOT EXISTS (\r\n           SELECT 1 FROM public.offers off \r\n           WHERE off.order_id = o.id \r\n           AND TRIM(off.supplier_name) ILIKE TRIM(p_seller_name)\r\n       )\r\n    ORDER BY car_brand;\r\nEND;\r\n$function$\n"
  },
  {
    "function_name": "get_seller_feed",
    "definition": "CREATE OR REPLACE FUNCTION public.get_seller_feed(p_seller_name text, p_tab text, p_page integer, p_limit integer, p_search text DEFAULT ''::text, p_sort_col text DEFAULT 'created_at'::text, p_sort_dir text DEFAULT 'desc'::text, p_brand_filter text DEFAULT NULL::text)\n RETURNS TABLE(id bigint, created_at timestamp with time zone, client_name text, car_brand text, car_model text, car_year text, vin text, status_admin text, status_client text, status_supplier text, visible_to_client boolean, offers_count bigint, items jsonb, my_offer jsonb, total_count bigint, count_new bigint, count_history bigint)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_offset INTEGER := (p_page - 1) * p_limit;\r\n    v_search_safe TEXT := COALESCE(p_search, '');\r\n    v_search_pattern TEXT := '%' || v_search_safe || '%';\r\n    v_sql TEXT;\r\n    v_sort_clause TEXT;\r\nBEGIN\r\n    IF p_sort_col = 'id' THEN v_sort_clause := 'ct.id';\r\n    ELSIF p_sort_col = 'brand' THEN v_sort_clause := 'ct.car_brand';\r\n    ELSIF p_sort_col = 'model' THEN v_sort_clause := 'ct.car_model';\r\n    ELSE v_sort_clause := 'ct.created_at'; END IF;\r\n\r\n    IF p_sort_dir = 'asc' THEN v_sort_clause := v_sort_clause || ' ASC';\r\n    ELSE v_sort_clause := v_sort_clause || ' DESC'; END IF;\r\n\r\n    v_sql := '\r\n    WITH base_orders AS (\r\n        SELECT \r\n            o.*,\r\n            (SELECT COUNT(*) FROM public.offers off WHERE off.order_id = o.id) as o_count,\r\n            (\r\n                SELECT row_to_json(off_data)::jsonb\r\n                FROM (\r\n                    SELECT \r\n                        off.id, \r\n                        off.supplier_name, \r\n                        (\r\n                            SELECT jsonb_agg(jsonb_build_object(''id'', ofi.id, ''name'', ofi.name, ''quantity'', ofi.quantity, ''sellerPrice'', ofi.price, ''weight'', ofi.weight, ''deliveryWeeks'', ofi.delivery_days / 7, ''photoUrl'', ofi.photo_url, ''offeredQuantity'', ofi.quantity, ''rank'', CASE WHEN ofi.is_winner THEN ''ЛИДЕР'' ELSE '''' END, ''adminComment'', ofi.admin_comment))\r\n                            FROM public.offer_items ofi\r\n                            WHERE ofi.offer_id = off.id\r\n                        ) as items\r\n                    FROM public.offers off\r\n                    WHERE off.order_id = o.id AND TRIM(off.supplier_name) ILIKE TRIM($1)\r\n                    LIMIT 1\r\n                ) off_data\r\n            ) as my_off\r\n        FROM public.orders o\r\n        WHERE \r\n            -- Поиск (ID, VIN, Model, Items)\r\n            ($2 = '''' OR (\r\n                o.vin ILIKE $3 OR\r\n                o.id::TEXT ILIKE $3 OR\r\n                o.car_model ILIKE $3 OR\r\n                o.car_brand ILIKE $3 OR\r\n                EXISTS (\r\n                    SELECT 1 FROM public.order_items oi \r\n                    WHERE oi.order_id = o.id AND oi.name ILIKE $3\r\n                )\r\n            ))\r\n            -- Фильтр по бренду\r\n            AND ($7 IS NULL OR o.car_brand ILIKE $7)\r\n    ),\r\n    tab_new AS (\r\n        SELECT * FROM base_orders \r\n        WHERE my_off IS NULL \r\n          AND status_admin NOT IN (''ЗАКРЫТ'', ''Аннулирован'', ''Отказ'', ''Выполнен'', ''В пути'')\r\n    ),\r\n    tab_history AS (\r\n        SELECT * FROM base_orders WHERE my_off IS NOT NULL\r\n    ),\r\n    current_tab AS (\r\n        SELECT * FROM \r\n        CASE \r\n            WHEN $4 = ''new'' THEN (SELECT * FROM tab_new)\r\n            WHEN $4 = ''history'' THEN (SELECT * FROM tab_history)\r\n            ELSE NULL\r\n        END t\r\n    ),\r\n    counts AS (\r\n        SELECT \r\n            (SELECT COUNT(*) FROM tab_new) as c_new,\r\n            (SELECT COUNT(*) FROM tab_history) as c_history\r\n    )\r\n    SELECT \r\n        ct.id, ct.created_at, ct.client_name, ct.car_brand, ct.car_model, ct.car_year, ct.vin, \r\n        ct.status_admin, ct.status_client, ct.status_supplier, ct.visible_to_client, ct.o_count,\r\n        (SELECT jsonb_agg(jsonb_build_object(''id'', oi.id, ''name'', oi.name, ''quantity'', oi.quantity, ''category'', oi.category)) FROM public.order_items oi WHERE oi.order_id = ct.id) as items,\r\n        ct.my_off,\r\n        (SELECT COUNT(*) FROM current_tab) as c_total,\r\n        c.c_new, c.c_history\r\n    FROM current_tab ct, counts c\r\n    ORDER BY ' || v_sort_clause || '\r\n    LIMIT $5 OFFSET $6';\r\n\r\n    RETURN QUERY EXECUTE v_sql \r\n    USING p_seller_name, v_search_safe, v_search_pattern, p_tab, p_limit, v_offset, p_brand_filter;\r\nEND;\r\n$function$\n"
  },
  {
    "function_name": "reset_db",
    "definition": "CREATE OR REPLACE FUNCTION public.reset_db()\n RETURNS void\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n  -- TRUNCATE удаляет всё из таблицы мгновенно\r\n  -- RESTART IDENTITY сбрасывает счетчик ID на 1\r\n  -- CASCADE удаляет зависимые данные (товары, офферы)\r\n  TRUNCATE TABLE public.orders RESTART IDENTITY CASCADE;\r\nEND;\r\n$function$\n"
  }
]